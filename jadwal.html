<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Digital Interaktif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8;
            scroll-behavior: smooth;
        }
        /* Tinggi slot disesuaikan untuk interval 5 menit */
        .time-slot {
            height: 20px; /* Lebih pendek untuk 5 menit */
            border-top: 1px solid #f0f2f5; /* Garis tipis untuk setiap slot */
        }
        /* Style untuk penanda visual grid */
        .time-slot-hour {
            border-top: 2px solid #d1d5db; /* Garis tebal untuk jam penuh */
        }
        .time-slot-half-hour {
            border-top: 1px dashed #e5e7eb; /* Garis putus-putus untuk setengah jam */
        }
        .time-label-hour {
            font-weight: 600; /* Teks tebal untuk jam penuh */
        }

        .subject-card {
            border-radius: 8px;
            transition: all 0.3s ease;
            min-width: 120px;
            max-width: 100%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            padding: 8px;
            position: absolute;
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex-shrink: 0;
            z-index: 3; /* Pastikan kartu di atas garis */
        }
        
        /* ✅ REVISI: z-index diubah ke -1 agar berada di belakang card */
        .subject-card::before, .subject-card::after,
        .stacked-summary-card::before, .stacked-summary-card::after {
            content: '';
            position: absolute;
            right: 100%; /* Mulai dari sisi kiri kartu */
            width: 100vw; /* Lebar yang sangat besar agar mencapai label waktu */
            height: 1px;
            background-image: linear-gradient(to right, #a0aec0 50%, transparent 50%);
            background-size: 8px 1px;
            background-repeat: repeat-x;
            z-index: -1; /* Di belakang kartu */
        }
        .subject-card::before, .stacked-summary-card::before {
            top: 0; /* Garis waktu mulai */
        }
        .subject-card::after, .stacked-summary-card::after {
            bottom: 0; /* Garis waktu selesai */
        }

        /* Style untuk tooltip kustom */
        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: default;
        }
        .tooltip-text {
            visibility: hidden;
            width: 60px;
            background-color: #374151; /* gray-700 */
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Posisikan di atas elemen */
            left: 50%;
            margin-left: -30px; /* Pusatkan tooltip */
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #374151 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .subject-card:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        .day-column {
            position: relative;
        }
        .time-label {
            width: 80px;
            text-align: right;
            position: sticky;
            left: 0;
            background-color: #f0f4f8;
            z-index: 6;
        }
        .schedule-column {
            position: relative;
            border-right: 1px solid #e2e8f0;
            min-width: 200px;
            flex-grow: 1;
        }
        .schedule-header {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 5; 
            height: 48px; 
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
        }
        .teacher-summary {
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .teacher-summary:hover {
            cursor: pointer;
            transform: scale(1.02);
            transition: transform 0.2s ease-in-out;
        }
        .subject-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        th.sortable {
            cursor: pointer;
            user-select: none;
        }
        #btnReset {
            visibility: hidden;
        }


        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background-color: white;
            }
            .print-container {
                width: 100% !important;
                overflow: visible !important;
            }
            .subject-card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
        }
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        .schedule-container {
            display: flex;
            overflow-x: auto;
            position: relative;
        }
        .time-labels-container {
            position: sticky;
            left: 0;
            z-index: 7;
            background-color: #f0f4f8;
        }
        .schedule-columns-container {
            display: flex;
            min-width: min-content;
            overflow-x: auto;
        }
        @media (max-width: 768px) {
            .subject-card {
                min-width: 100px;
                font-size: 0.8rem;
            }
            .schedule-column {
                min-width: 150px;
            }
        }
        .more-items-indicator {
            font-size: 0.7rem;
            margin-top: 2px;
        }
        .schedule-card-modal {
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 300px;
            width: 100%;
        }
        .stacked-card {
            max-width: 300px;
            width: 100%;
        }
        .draggable-card {
            cursor: move;
        }
        .dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }
        .dropzone {
            border: 2px dashed #ccc;
            border-radius: 6px;
            padding: 10px;
            margin: 5px 0;
            transition: all 0.3s;
        }
        .dropzone.active {
            border-color: #4f46e5;
            background-color: rgba(238, 242, 255, 0.5);
        }
        .dropzone.invalid {
            border-color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .import-export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .edit-modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            margin: 0 auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .edit-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .conflict-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #ef4444;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            animation: slideIn 0.3s, fadeOut 0.5s 2.5s forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .card-actions {
            display: none;
            position: absolute;
            bottom: 5px;
            right: 5px;
        }
        .subject-card:hover .card-actions {
            display: flex;
            gap: 5px;
        }
        .action-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.8);
        }
        .action-btn.edit {
            color: #3b82f6;
        }
        .action-btn.delete {
            color: #ef4444;
        }
        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }
        .export-options label {
            font-size: 14px;
            margin-right: 5px;
        }
        .monthly-day {
            min-height: 100px;
            position: relative;
        }
        .monthly-event {
            font-size: 0.75rem;
            padding: 2px 4px;
            margin-bottom: 2px;
            border-radius: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .swal2-popup {
            max-width: 700px !important;
        }
        .time-slot-header {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 4;
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
            min-width: 200px;
            text-align: center;
        }
        .schedule-column-content {
            position: relative;
        }
        /* New styles for input management */
        .input-management {
            display: none;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .input-management.active {
            display: block;
        }
        .input-dropdown {
            position: relative;
            display: inline-block;
        }
        .input-dropdown-btn {
            background-color: #4f46e5;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .input-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 10;
            border-radius: 0.375rem;
            overflow: hidden;
        }
        .input-dropdown-content a {
            color: #4b5563;
            padding: 0.75rem 1rem;
            text-decoration: none;
            display: block;
            transition: background-color 0.2s;
        }
        .input-dropdown-content a:hover {
            background-color: #f3f4f6;
        }
        .input-dropdown:hover .input-dropdown-content {
            display: block;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .data-table th, .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .data-table th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        .data-table tr:hover {
            background-color: #f9fafb;
        }
        .action-btns {
            display: flex;
            gap: 0.5rem;
        }
        .action-btn-table {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            cursor: pointer;
        }
        .edit-btn {
            background-color: #3b82f6;
            color: white;
        }
        .delete-btn {
            background-color: #ef4444;
            color: white;
        }
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .clickable-day:hover {
            background-color: #eef2ff !important; /* light indigo */
            transition: background-color 0.2s;
        }
        /* Style for stacked card */
        .stacked-summary-card {
            background-color: #4b5563; /* Gray */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: absolute;
            z-index: 3; /* Pastikan kartu di atas garis */
        }
        .stacked-summary-card:hover {
            background-color: #374151;
        }

    </style>
</head>
<body>
    <div class="min-h-screen flex flex-col">
        <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg">
            <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-2xl md:text-3xl font-bold mb-2 md:mb-0">Jadwal Digital Interaktif</h1>
                <div class="flex flex-wrap justify-center gap-2">
                    <button id="btnDailyView" class="bg-white text-indigo-700 hover:bg-indigo-100 px-3 py-2 rounded-lg font-medium shadow-md transition-all flex items-center">
                        <span class="mr-1">📅</span> Jadwal Harian
                    </button>
                    <button id="btnWeeklyView" class="bg-white text-indigo-700 hover:bg-indigo-100 px-3 py-2 rounded-lg font-medium shadow-md transition-all flex items-center">
                        <span class="mr-1">📆</span> Rekap Mingguan
                    </button>
                    <button id="btnMonthlyView" class="bg-white text-indigo-700 hover:bg-indigo-100 px-3 py-2 rounded-lg font-medium shadow-md transition-all flex items-center">
                        <span class="mr-1">🗓</span> Kalender Bulanan
                    </button>
                    <button id="btnPrint" class="bg-white text-indigo-700 hover:bg-indigo-100 px-3 py-2 rounded-lg font-medium shadow-md transition-all flex items-center">
                        <span class="mr-1">🖨</span> Cetak Jadwal
                    </button>
                    <div class="input-dropdown">
                        <div class="input-dropdown-btn bg-white text-indigo-700 hover:bg-indigo-100 px-3 py-2 rounded-lg font-medium shadow-md transition-all flex items-center">
                            <span>➕ Input Data</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                        <div class="input-dropdown-content">
                            <a href="#" class="input-option" data-type="schedule">Jadwal</a>
                            <a href="#" class="input-option" data-type="teacher">Pengajar</a>
                            <a href="#" class="input-option" data-type="subject">Mata Pelajaran</a>
                            <a href="#" class="input-option" data-type="location">Lokasi/Ruang</a>
                            <a href="#" class="input-option" data-type="class">Kelas</a>
                        </div>
                    </div>
                    <div class="import-export-buttons no-print">
                        <button id="btnExport" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 transition-all">
                        📤 Ekspor Jadwal
                        </button>
                        <button id="btnOpenImportModal" class="bg-yellow-600 text-white px-3 py-2 rounded-lg hover:bg-yellow-700 transition-all">
                        📥 Impor Jadwal
                        </button>
                        <button id="btnReset" class="bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700 transition-all">
                            Reset
                        </button>
                        <input type="file" id="importFile" class="hidden" accept=".xlsx,.xls,.csv">
                    </div>
                    <button id="btnLogout" class="bg-gray-600 text-white px-3 py-2 rounded-lg hover:bg-gray-700 transition-all no-print">
                        🚪 Keluar
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-grow container mx-auto px-4 py-6">
            <div id="inputManagement" class="input-management">
                <div id="scheduleInput" class="input-section">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Input Jadwal Baru</h2>
                    <form id="scheduleForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="scheduleDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Waktu Mulai</label>
                            <input type="time" id="startTimeInput" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" step="300" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Waktu Selesai</label>
                            <input type="time" id="endTimeInput" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" step="300" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mata Pelajaran</label>
                            <select id="subjectName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pengajar</label>
                            <select id="teacherName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Lokasi/Ruang</label>
                            <select id="location" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                            <select id="className" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-all">Tambah Jadwal</button>
                        </div>
                    </form>
                    
                    <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-4">Daftar Jadwal</h3>
                    <div class="w-full max-w-6xl mx-auto">

                        <div class="flex flex-wrap justify-between items-center gap-2 mb-3">
                            <label class="text-sm">Tampilkan:
                            <select id="scheduleEntriesPerPage" class="border px-2 py-1 rounded text-sm">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select> data
                            </label>

                            <div class="flex items-center gap-2">
                                <button id="deleteSelectedSchedules" disabled
                                    class="bg-red-600 text-white px-3 py-1 rounded text-sm my-2 opacity-50 cursor-not-allowed">
                                    Hapus Terpilih
                                </button>
                                <input type="text" id="scheduleSearch" placeholder="Cari..." class="border px-3 py-1 rounded text-sm" />
                                <button id="btnResetFilter" title="Reset semua filter" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 transition-all">
                                    Reset Filter
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-2 mb-4 text-sm">
                            <input type="date" id="filterDate" class="border px-2 py-1 rounded" placeholder="Tanggal" />
                            <input type="text" id="filterTime" class="border px-2 py-1 rounded" placeholder="Waktu (07:00)" />
                            <input type="text" id="filterSubject" class="border px-2 py-1 rounded" placeholder="Mata Pelajaran" />
                            <input type="text" id="filterTeacher" class="border px-2 py-1 rounded" placeholder="Pengajar" />
                            <input type="text" id="filterLocation" class="border px-2 py-1 rounded" placeholder="Lokasi" />
                            <input type="text" id="filterClass" class="border px-2 py-1 rounded" placeholder="Kelas" />
                        </div>

                        <table id="scheduleTable" class="w-full border text-sm">
                            <thead class="bg-gray-100 text-left">
                            <tr>
                                <th class="p-2 border"><input type="checkbox" id="scheduleSelectAll" /></th>
                                <th class="p-2 border" data-sort="date" data-label="Tanggal">Tanggal</th>
                                <th class="p-2 border" data-sort="time" data-label="Waktu">Waktu</th>
                                <th class="p-2 border" data-sort="subject" data-label="Mapel">Mapel</th>
                                <th class="p-2 border" data-sort="teacher" data-label="Pengajar">Pengajar</th>
                                <th class="p-2 border" data-sort="location" data-label="Lokasi">Lokasi</th>
                                <th class="p-2 border" data-sort="class" data-label="Kelas">Kelas</th>
                                <th class="p-2 border w-32">Aksi</th>
                            </tr>
                            </thead>
                            <tbody id="scheduleTableBody">
                            </tbody>
                        </table>

                        <div id="schedulePagination" class="flex justify-between items-center mt-3 text-sm font-medium"></div>
                        </div>

                </div>

                <div id="teacherInput" class="input-section hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Input Pengajar Baru</h2>
                    <form id="teacherForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Pengajar</label>
                            <input type="text" id="teacherNameInput" placeholder="Nama Pengajar" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="teacherEmailInput" placeholder="Email" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">No HP</label>
                            <input type="text" id="teacherPhoneInput" placeholder="No HP" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="md:col-span-3">
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-all">Tambah Pengajar</button>
                        </div>
                    </form>
                    
                    <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-4">Daftar Pengajar</h3>
                    <div class="flex justify-between items-center my-2">
                        <div class="flex items-center gap-2 mb-2">
                            <label for="teacherEntriesPerPage" class="text-sm text-gray-700">Tampilkan:</label>
                            <select id="teacherEntriesPerPage" class="border px-2 py-1 rounded text-sm">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span class="text-sm text-gray-700">data</span>
                        </div>
                        <div>
                            <button id="deleteSelectedTeachers" disabled
                                class="bg-red-600 text-white px-3 py-1 rounded text-sm my-2 opacity-50 cursor-not-allowed">
                                Hapus Terpilih
                            </button>
                            <input type="text" id="teacherSearch" placeholder="Cari..." class="border px-3 py-1 rounded text-sm" />
                        </div>
                    </div>

                    <div class="overflow-auto" style="min-height: 480px;">
                    <table class="data-table w-full" id="teacherTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="teacherSelectAll" /></th>
                                <th data-sort="name" data-label="Nama" class="sortable">Nama</th>
                                <th data-sort="email" data-label="Email" class="sortable">Email</th>
                                <th data-sort="phone" data-label="No HP" class="sortable">No HP</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="teacherTableBody">
                        </tbody>
                    </table>
                    </div>

                    <div id="teacherPagination" class="flex justify-between items-center mt-3 text-sm font-medium"></div>

                </div>

                <div id="subjectInput" class="input-section hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Input Mata Pelajaran Baru</h2>
                    <form id="subjectForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Mata Pelajaran</label>
                            <input type="text" id="subjectNameInput" placeholder="Nama Mata Pelajaran" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all">Tambah Mata Pelajaran</button>
                        </div>
                    </form>
                                
                                <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-4">Daftar Mata Pelajaran</h3>
                                <div class="flex justify-between items-center my-2">
                                    <div>
                                        <label class="text-sm">Tampilkan:
                                        <select id="subjectEntriesPerPage" class="border px-2 py-1 rounded text-sm">
                                            <option value="10">10</option>
                                            <option value="25">25</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select> data
                                        </label>
                                    </div>

                                    <div>
                                        <button id="deleteSelectedSubjects" 
                                            class="bg-red-600 text-white px-3 py-1 rounded text-sm my-2 opacity-50 cursor-not-allowed" disabled>
                                            Hapus Terpilih
                                        </button>
                                        <input type="text" id="subjectSearch" placeholder="Cari mata pelajaran..." class="border px-3 py-1 rounded text-sm">
                                    </div>
                                </div>

                                <div class="w-full max-w-4xl mx-auto"> <table id="subjectTable" class="w-full text-sm border border-gray-300 rounded overflow-hidden">
                                    <thead class="bg-gray-100 text-left">
                                        <tr>
                                            <th class="p-2 border"><input type="checkbox" id="subjectSelectAll" /></th>
                                            <th class="p-2 border" data-sort="name" data-label="Nama Mapel">Nama Mapel</th>
                                            <th class="p-2 border w-32">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="subjectTableBody">
                                        </tbody>
                                </table>
                                </div>

                                <div id="subjectPagination" class="flex justify-between items-center mt-3 text-sm font-medium"></div>

                </div>

                <div id="locationInput" class="input-section hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Input Lokasi/Ruang Baru</h2>
                    <form id="locationForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Ruang</label>
                            <input type="text" id="locationNameInput" placeholder="Nama Ruang" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition-all">Tambah Lokasi</button>
                        </div>
                    </form>
                    
                    <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-4">Daftar Lokasi/Ruang</h3>
                    <div class="w-full max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm">Tampilkan:
                            <select id="locationEntriesPerPage" class="border px-2 py-1 rounded text-sm">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select> data
                            </label>


                            <div>
                                <button id="deleteSelectedLocations" 
                                    class="bg-red-600 text-white px-3 py-1 rounded text-sm my-2 opacity-50 cursor-not-allowed" disabled>
                                    Hapus Terpilih
                                </button>
                                <input type="text" id="locationSearch" placeholder="Cari lokasi..." class="border px-3 py-1 rounded text-sm">
                            </div>
                        </div>

                        <table id="locationTable" class="w-full text-sm border border-gray-300 rounded overflow-hidden">
                            <thead class="bg-gray-100 text-left">
                            <tr>
                                <th class="p-2 border"><input type="checkbox" id="locationSelectAll" /></th>
                                <th class="p-2 border" data-sort="name" data-label="Nama Lokasi">Nama Lokasi</th>
                                <th class="p-2 border w-32">Aksi</th>
                            </tr>
                            </thead>
                            <tbody id="locationTableBody"></tbody>
                        </table>

                        <div id="locationPagination" class="flex justify-between items-center mt-3 text-sm font-medium"></div>
                        </div>

                </div>

                <div id="classInput" class="input-section hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Input Kelas Baru</h2>
                    <form id="classForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas</label>
                            <input type="text" id="classNameInput" placeholder="Nama Kelas (cth: 3B, Bintara)" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">Tambah Kelas</button>
                        </div>
                    </form>
                    
                    <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-4">Daftar Kelas</h3>
                    <div class="w-full max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm">Tampilkan:
                            <select id="classEntriesPerPage" class="border px-2 py-1 rounded text-sm">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select> data
                            </label>

                            <div>
                                <button id="deleteSelectedClasses" 
                                    class="bg-red-600 text-white px-3 py-1 rounded text-sm my-2 opacity-50 cursor-not-allowed" disabled>
                                    Hapus Terpilih
                                </button>
                                <input type="text" id="classSearch" placeholder="Cari lokasi..." class="border px-3 py-1 rounded text-sm">
                            </div>
                        </div>

                        <table id="classTable" class="w-full text-sm border border-gray-300 rounded overflow-hidden">
                            <thead class="bg-gray-100 text-left">
                            <tr>
                                <th class="p-2 border"><input type="checkbox" id="classSelectAll" /></th>
                                <th class="p-2 border" data-sort="name" data-label="Nama Kelas">Nama Kelas</th>
                                <th class="p-2 border w-32">Aksi</th>
                            </tr>
                            </thead>
                            <tbody id="classTableBody"></tbody>
                        </table>

                        <div id="classPagination" class="flex justify-between items-center mt-3 text-sm font-medium"></div>
                        </div>

                </div>
            </div>

            <div id="dailyView" class="bg-white rounded-xl shadow-lg p-4 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Jadwal Harian</h2>
                    <div class="flex gap-2 items-center">
                        <button id="prevDay" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg transition-all">
                            ◀
                        </button>
                        <input type="date" id="currentDate" class="border border-gray-300 rounded-lg px-3 py-1 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button id="nextDay" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg transition-all">
                            ▶
                        </button>
                    </div>
                </div>
                <div class="overflow-auto print-container" style="max-height: 70vh;">
                    <div class="schedule-container">
                        <div class="time-labels-container">
                            <div class="h-12"></div> <div id="timeLabels" class="flex flex-col">
                            </div>
                        </div>
                        <div class="schedule-columns-container flex-grow">
                            <div id="dailySchedule" class="flex">
                                </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="weeklyView" class="bg-white rounded-xl shadow-lg p-4 mb-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Rekap Mingguan</h2>
                    <div class="flex gap-2 items-center">
                        <button id="btnExportWeekly" class="bg-green-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-700 transition-all">
                            📤 Ekspor Rekap
                        </button>
                        <button id="prevWeek" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg transition-all">
                            ◀
                        </button>
                        <span id="currentWeek" class="bg-indigo-100 text-indigo-800 px-4 py-1 rounded-lg font-medium"></span>
                        <button id="nextWeek" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg transition-all">
                            ▶
                        </button>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">Rekap Pengajar</h3>
                    <div id="teachersSummary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-medium text-gray-700 mb-3">Rekap Mata Pelajaran</h3>
                    <div id="subjectsSummary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
                </div>
            </div>

            <div id="monthlyView" class="bg-white rounded-xl shadow-lg p-4 mb-6 hidden">
                <div class="calendar-controls">
                    <h2 class="text-xl font-semibold text-gray-800">Kalender Bulanan</h2>
                    <div class="flex gap-2">
                        <button id="prevMonth" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg transition-all">
                            ◀
                        </button>
                        <span id="currentMonth" class="bg-indigo-100 text-indigo-800 px-4 py-1 rounded-lg font-medium">Agustus 2023</span>
                        <button id="nextMonth" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg transition-all">
                            ▶
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center mb-2">
                    <div class="font-medium text-gray-500">Min</div>
                    <div class="font-medium text-gray-500">Sen</div>
                    <div class="font-medium text-gray-500">Sel</div>
                    <div class="font-medium text-gray-500">Rab</div>
                    <div class="font-medium text-gray-500">Kam</div>
                    <div class="font-medium text-gray-500">Jum</div>
                    <div class="font-medium text-gray-500">Sab</div>
                </div>
                <div id="monthlyCalendar" class="grid grid-cols-7 gap-1">
                </div>
            </div>
        </main>

        <div class="modal fade" id="stackedScheduleModal" tabindex="-1" aria-labelledby="stackedScheduleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="stackedScheduleModalLabel">Jadwal pada Slot Waktu Ini</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="stackedScheduleContent" class="d-flex flex-wrap gap-3">
                            </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="editModal" class="edit-modal-overlay hidden">
            <div class="edit-modal-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Edit Jadwal</h2>
                <form id="editScheduleForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="editScheduleId">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="editScheduleDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Waktu Mulai</label>
                        <input type="time" id="editStartTimeInput" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" step="300" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Waktu Selesai</label>
                        <input type="time" id="editEndTimeInput" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" step="300" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mata Pelajaran</label>
                        <select id="editSubjectName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pengajar</label>
                        <select id="editTeacherName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Lokasi/Ruang</label>
                        <select id="editLocation" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                        <select id="editClassName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </select>
                    </div>
                    <div class="md:col-span-2 flex justify-end gap-2">
                        <button type="button" id="cancelEdit" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-all">Batal</button>
                        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-all">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="editTeacherModal" class="edit-modal-overlay hidden">
            <div class="edit-modal-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Edit Pengajar</h2>
                <form id="editTeacherForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="hidden" id="editTeacherId">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Pengajar</label>
                        <input type="text" id="editTeacherNameInput" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="editTeacherEmailInput" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">No HP</label>
                        <input type="text" id="editTeacherPhoneInput" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="md:col-span-3 flex justify-end gap-2">
                        <button type="button" id="cancelEditTeacher" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-all">Batal</button>
                        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-all">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="editSubjectModal" class="edit-modal-overlay hidden">
            <div class="edit-modal-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Edit Mata Pelajaran</h2>
                <form id="editSubjectForm" class="grid grid-cols-1 gap-4">
                    <input type="hidden" id="editSubjectId">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Mata Pelajaran</label>
                        <input type="text" id="editSubjectNameInput" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" id="cancelEditSubject" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-all">Batal</button>
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="editLocationModal" class="edit-modal-overlay hidden">
            <div class="edit-modal-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Edit Lokasi/Ruang</h2>
                <form id="editLocationForm" class="grid grid-cols-1 gap-4">
                    <input type="hidden" id="editLocationId">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Ruang</label>
                        <input type="text" id="editLocationNameInput" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" id="cancelEditLocation" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-all">Batal</button>
                        <button type="submit" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition-all">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="editClassModal" class="edit-modal-overlay hidden">
            <div class="edit-modal-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Edit Kelas</h2>
                <form id="editClassForm" class="grid grid-cols-1 gap-4">
                    <input type="hidden" id="editClassId">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas</label>
                        <input type="text" id="editClassNameInput" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" id="cancelEditClass" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-all">Batal</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="modal fade" id="detailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content" id="detailModalContent">
                </div>
            </div>
        </div>


        <footer class="bg-gray-800 text-white py-4 no-print">
            <div class="container mx-auto px-4 text-center">
                <p>© 2023 Jadwal Digital Interaktif - Template untuk Lembaga Pendidikan</p>
            </div>
        </footer>
    </div>

    <div id="exportScheduleModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">Ekspor Jadwal</h2>
            <button id="closeExportScheduleBtn" class="text-gray-500 hover:text-red-500 text-xl">&times;</button>
            </div>

            <div class="space-y-4 text-sm">
                <label><input type="radio" name="exportType" value="all" checked> Ekspor Semua Jadwal</label>
                <label><input type="radio" name="exportType" value="day"> Berdasarkan Tanggal</label>
                <input type="date" id="exportDate" class="border px-2 py-1 rounded w-full hidden" />

                <label><input type="radio" name="exportType" value="week"> Berdasarkan Minggu</label>
                <div class="grid grid-cols-2 gap-2 hidden" id="exportWeekRange">
                    <input type="date" id="exportWeekStart" class="border px-2 py-1 rounded" placeholder="Mulai">
                    <input type="date" id="exportWeekEnd" class="border px-2 py-1 rounded" placeholder="Selesai">
                </div>

                <label><input type="radio" name="exportType" value="month"> Berdasarkan Bulan</label>
                <div class="grid grid-cols-2 gap-2 hidden" id="exportMonthYear">
                    <select id="exportMonth" class="border px-2 py-1 rounded"></select>
                    <input type="number" id="exportYear" placeholder="Tahun" class="border px-2 py-1 rounded">
                </div>

                <label><input type="radio" name="exportType" value="category"> Berdasarkan Kategori</label>
                <select id="exportCategory" class="border px-2 py-1 rounded w-full hidden">
                    <option value="">Pilih Kategori</option>
                    <option value="class">Kelas</option>
                    <option value="subject">Mapel</option>
                    <option value="teacher">Pengajar</option>
                    <option value="location">Lokasi</option>
                </select>
                <select id="exportCategoryValue" class="border px-2 py-1 rounded w-full hidden"></select>
            </div>


            <div class="mt-6 flex justify-end gap-2">
            <button id="btnExportSchedule" class="bg-green-600 text-white px-4 py-2 rounded">Ekspor Excel</button>
            <button id="cancelExportScheduleBtn" class="text-gray-600 hover:text-red-500">Batal</button>
            </div>
        </div>
    </div>

    <div id="importScheduleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-xl">
            <h2 class="text-xl font-semibold mb-4">Impor Jadwal dari File</h2>
            
            <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm">
                <h3 class="font-semibold text-blue-800 mb-2">Langkah-langkah Impor:</h3>
                <ol class="list-decimal list-inside space-y-1 text-blue-700">
                    <li>Unduh template file dengan mengklik tombol di bawah.</li>
                    <li>Isi data jadwal sesuai format pada template. <strong>Jangan ubah header kolom.</strong></li>
                    <li>Pastikan data di kolom 'Pengajar', 'Mata Pelajaran', 'Lokasi', dan 'Kelas' sudah ada di sistem.</li>
                    <li>Pilih file yang sudah diisi, lalu periksa pratinjau.</li>
                    <li>Jika semua data valid (tidak ada baris merah), klik tombol "Impor ke Firebase".</li>
                </ol>
                <div class="mt-3">
                    <button id="downloadTemplateBtn" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition-all text-xs">
                        📥 Unduh Template Impor
                    </button>
                </div>
            </div>

            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" class="mb-4" />
            <div id="importPreview" class="overflow-x-auto max-h-64 overflow-y-auto border rounded p-2 text-sm hidden"></div>
            <div class="mt-4 flex justify-end gap-2">
                <button id="btnCancelImport" class="text-gray-600 hover:text-red-600">Batal</button>
                <button id="btnConfirmImport" class="bg-green-600 text-white px-4 py-1 rounded" disabled>Impor ke Firebase</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script>
        const authConfig = {
            apiKey: "AIzaSyC_YrhgmzRIF4fOheWcU506laiJ2ml1GCc",
            authDomain: "aplikasi-jadwal-b2818.firebaseapp.com",
            databaseURL: "https://aplikasi-jadwal-b2818-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aplikasi-jadwal-b2818",
            storageBucket: "aplikasi-jadwal-b2818.appspot.com",
            messagingSenderId: "774827399231",
            appId: "1:774827399231:web:e4541dcf4e0690e0c4408a",
            measurementId: "G-YJRSSSZL6X"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(authConfig);
        }
        
        const auth = firebase.auth();

        auth.onAuthStateChanged(user => {
            if (user) {
                // Pengguna sudah login, biarkan halaman ditampilkan
                console.log('Pengguna terautentikasi:', user.email);
                
                // Tambahkan fungsionalitas logout ke tombol
                const btnLogout = document.getElementById('btnLogout');
                if(btnLogout) {
                    btnLogout.addEventListener('click', () => {
                        auth.signOut().then(() => {
                            // Alihkan ke halaman login (index.html) setelah logout berhasil
                            window.location.href = 'index.html';
                        }).catch(error => {
                            console.error('Gagal logout:', error);
                        });
                    });
                }

            } else {
                // Pengguna belum login, alihkan ke halaman login (index.html)
                console.log('Tidak ada pengguna, mengalihkan ke login...');
                window.location.href = 'index.html';
            }
        });
    </script>
    
    <script>
        // Firebase Configuration (tetap ada untuk Realtime Database)
        const firebaseConfig = {
            apiKey: "AIzaSyC_YrhgmzRIF4fOheWcU506laiJ2ml1GCc",
            authDomain: "aplikasi-jadwal-b2818.firebaseapp.com",
            databaseURL: "https://aplikasi-jadwal-b2818-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aplikasi-jadwal-b2818",
            storageBucket: "aplikasi-jadwal-b2818.appspot.com",
            messagingSenderId: "774827399231",
            appId: "1:774827399231:web:e4541dcf4e0690e0c4408a",
            measurementId: "G-YJRSSSZL6X"
        };

        // Initialize Firebase (jika belum ada)
        if (!firebase.apps.length) {
           firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        document.addEventListener('DOMContentLoaded', function() {
            // ====================
            // DATA STRUCTURES
            // ====================
            let schedules = [];      
            let teachers = [];
            let subjects = [];
            let locations = [];
            let classes = [];
            let teacherColorMap = {};
            let subjectColorMap = {};


            // ====================
            // STATE VARIABLES
            // ====================
            // Date/View related
            let currentDate = new Date();
            let currentMonth = currentDate.getMonth();
            let currentYear = currentDate.getFullYear();
            let currentWeekStart = getWeekStartDate(currentDate);
            let draggedSchedule = null;
            let currentInputType = null;
            let importedSchedules = [];

            // Pagination and sorting
            const paginationConfig = {
                schedule: { currentPage: 1, entriesPerPage: 10, searchTerm: '', sortKey: null, sortAsc: true },
                teacher: { currentPage: 1, entriesPerPage: 10, searchTerm: '', sortKey: null, sortAsc: true },
                subject: { currentPage: 1, entriesPerPage: 10, searchTerm: '', sortKey: null, sortAsc: true },
                location: { currentPage: 1, entriesPerPage: 10, searchTerm: '', sortKey: null, sortAsc: true },
                class: { currentPage: 1, entriesPerPage: 10, searchTerm: '', sortKey: null, sortAsc: true }
            };

            // ====================
            // DOM ELEMENTS
            // ====================
            // Main views
            const inputManagement = document.getElementById('inputManagement');
            const dailyView = document.getElementById('dailyView');
            const weeklyView = document.getElementById('weeklyView');
            const monthlyView = document.getElementById('monthlyView');
            
            // Date controls
            const currentDateInput = document.getElementById('currentDate');
            const scheduleDateInput = document.getElementById('scheduleDate');
            const prevDay = document.getElementById('prevDay');
            const nextDay = document.getElementById('nextDay');
            const prevWeek = document.getElementById('prevWeek');
            const nextWeek = document.getElementById('nextWeek');
            const prevMonth = document.getElementById('prevMonth');
            const nextMonth = document.getElementById('nextMonth');
            
            // View buttons
            const btnDailyView = document.getElementById('btnDailyView');
            const btnWeeklyView = document.getElementById('btnWeeklyView');
            const btnMonthlyView = document.getElementById('btnMonthlyView');
            const btnReset = document.getElementById('btnReset');
            const btnPrint = document.getElementById('btnPrint');
            const btnExport = document.getElementById('btnExport');
            const btnResetFilter = document.getElementById('btnResetFilter');
            const btnExportWeekly = document.getElementById('btnExportWeekly');
            
            // Schedule display
            const timeLabels = document.getElementById('timeLabels');
            const dailySchedule = document.getElementById('dailySchedule');
            const currentWeekElement = document.getElementById('currentWeek');
            const currentMonthElement = document.getElementById('currentMonth');
            
            // Modals
            const stackedScheduleModal = new bootstrap.Modal(document.getElementById('stackedScheduleModal'));
            const editModal = document.getElementById('editModal');
            
            // Forms
            const scheduleForm = document.getElementById('scheduleForm');
            const startTimeInput = document.getElementById('startTimeInput');
            const endTimeInput = document.getElementById('endTimeInput');
            const subjectName = document.getElementById('subjectName');
            const teacherName = document.getElementById('teacherName');
            const location = document.getElementById('location');
            const className = document.getElementById('className');
            
            // Edit form
            const editScheduleForm = document.getElementById('editScheduleForm');
            const editScheduleId = document.getElementById('editScheduleId');
            const editScheduleDate = document.getElementById('editScheduleDate');
            const editStartTimeInput = document.getElementById('editStartTimeInput');
            const editEndTimeInput = document.getElementById('editEndTimeInput');
            const editSubjectName = document.getElementById('editSubjectName');
            const editTeacherName = document.getElementById('editTeacherName');
            const editLocation = document.getElementById('editLocation');
            const editClassName = document.getElementById('editClassName');
            const cancelEdit = document.getElementById('cancelEdit');
            
            // Input sections
            const inputSections = {
                schedule: document.getElementById('scheduleInput'),
                teacher: document.getElementById('teacherInput'),
                subject: document.getElementById('subjectInput'),
                location: document.getElementById('locationInput'),
                class: document.getElementById('classInput')
            };
            
            // Input options
            const inputOptions = document.querySelectorAll('.input-option');

            // ====================
            // UTILITY FUNCTIONS
            // ====================
            function isTimeMultipleOfFive(timeString) {
                if (!timeString) return false;
                const minutes = parseInt(timeString.split(':')[1], 10);
                return minutes % 5 === 0;
            }

            function getRandomColor() {
                const hue = Math.floor(Math.random() * 360);
                const saturation = 70 + Math.floor(Math.random() * 30);
                const lightness = 45 + Math.floor(Math.random() * 20);
                return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            }

            function getTeacherColor(teacherName) {
                return teacherColorMap[teacherName] || '#4f46e5'; // default indigo
            }

            function getSubjectColor(subjectName) {
                return subjectColorMap[subjectName] || '#10b981'; // default hijau
            }


            function getContrastColor(hexColor) {
                if (hexColor.startsWith('hsl')) {
                    const matches = hexColor.match(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/);
                    if (matches) {
                        const lightness = parseInt(matches[3]);
                        return lightness > 50 ? '#000000' : '#ffffff';
                    }
                    return '#000000';
                }
                
                const r = parseInt(hexColor.substr(1, 2), 16);
                const g = parseInt(hexColor.substr(3, 2), 16);
                const b = parseInt(hexColor.substr(5, 2), 16);
                
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                return luminance > 0.5 ? '#000000' : '#ffffff';
            }

            function getWeekStartDate(dateInput) {
                const date = new Date(dateInput);
                if (isNaN(date)) return null;
                const day = date.getDay();
                const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(date.setDate(diff));
            }

            function formatDateDisplay(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            }

            function formatDateToDDMMYYYY(isoDate) {
                if (!isoDate || typeof isoDate !== 'string') return '-';
                const parts = isoDate.split('-'); // [YYYY, MM, DD]
                if (parts.length !== 3) return isoDate; // return original jika format salah
                return `${parts[2]}/${parts[1]}/${parts[0]}`; // DD/MM/YYYY
            }


            function convert12to24(time12h) {
                const [time, modifier] = time12h.split(' ');
                let [hours, minutes] = time.split(':');
                
                if (hours === '12') hours = '00';
                if (modifier === 'PM') hours = parseInt(hours, 10) + 12;
                
                return `${hours.toString().padStart(2, '0')}:${minutes}`;
            }

            function convertTimeFormat(time) {
                if (typeof time === 'number') {
                    const totalSeconds = time * 24 * 60 * 60;
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                } else if (typeof time === 'string') {
                    if (time.includes('PM') || time.includes('AM')) {
                        return convert12to24(time);
                    } else if (time.includes('.')) {
                        return time.replace('.', ':');
                    }
                    return time;
                }
                return '08:00';
            }

            function formatDate(date) {
                if (date instanceof Date) {
                    return date.toISOString().split('T')[0];
                } else if (typeof date === 'string') {
                    if (date.includes('/')) {
                        const [day, month, year] = date.split('/');
                        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    } else if (date.includes('-')) {
                        const parts = date.split('-');
                        if (parts[0].length === 4) return date;
                        return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    }
                }
                return new Date().toISOString().split('T')[0];
            }

            function showConfirmation(title, text, callback) {
                Swal.fire({
                    title: title,
                    text: text,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ya, hapus!',
                    cancelButtonText: 'Batal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        callback();
                    }
                });
            }

            function showConflictNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'conflict-notification';
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }

            function updateCurrentWeekDisplay() {
                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                currentWeekElement.textContent = `
                    ${currentWeekStart.toLocaleDateString('id-ID', options)} - 
                    ${weekEnd.toLocaleDateString('id-ID', options)}`;
            }

            function updateCurrentMonthDisplay() {
                const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                currentMonthElement.textContent = `${months[currentMonth]} ${currentYear}`;
            }

            function toggleInputSection(type) {
                inputManagement.classList.add('active');
                for (let key in inputSections) {
                    inputSections[key].classList.toggle('hidden', key !== type);
                }
            }



            // ====================
            // DATA LOADING FUNCTIONS
            // ====================
            function loadSchedules() {
                database.ref('schedules').once('value')
                    .then(snapshot => {
                        const data = snapshot.val();
                        schedules = data ? Object.entries(data).map(([id, value]) => ({ id, ...value })) : [];
                        localStorage.setItem('schedules', JSON.stringify(schedules));
                        renderAllViews();
                        renderScheduleTable();
                    })
                    .catch(error => {
                        console.error("Error loading schedules:", error);
                        schedules = [];
                        renderAllViews();
                        renderScheduleTable();
                    });
            }

            function loadTeachers() {
                database.ref('teachers').once('value')
                    .then(snapshot => {
                    const data = snapshot.val();
                    teachers = data ? Object.values(data) : [];
                    teacherColorMap = {}; // Reset
                    
                    teachers.forEach(teacher => {
                        teacherColorMap[teacher.name] = teacher.color || getRandomColor();
                    });

                    renderTeacherOptions();
                    renderTeacherTable();
                    })
                    .catch(error => {
                    console.error("Error loading teachers:", error);
                    teachers = [];
                    renderTeacherOptions();
                    renderTeacherTable();
                    });
            }

            function loadSubjects() {
                database.ref('subjects').once('value')
                    .then(snapshot => {
                    const data = snapshot.val();
                    subjects = data ? Object.values(data) : [];
                    subjectColorMap = {}; // Reset
                    
                    subjects.forEach(subject => {
                        subjectColorMap[subject.name] = subject.color || getRandomColor();
                    });

                    renderSubjectOptions();
                    renderSubjectTable();
                    })
                    .catch(error => {
                    console.error("Error loading subjects:", error);
                    subjects = [];
                    renderSubjectOptions();
                    renderSubjectTable();
                    });
            }


            function loadLocations() {
                database.ref('locations').once('value')
                    .then(snapshot => {
                        const data = snapshot.val();
                        locations = data ? Object.values(data) : [];
                        localStorage.setItem('locations', JSON.stringify(locations));
                        renderLocationOptions();
                        renderLocationTable();
                    })
                    .catch(error => {
                        console.error("Error loading locations:", error);
                        locations = [];
                        renderLocationOptions();
                        renderLocationTable();
                    });
            }

            function loadClasses() {
                database.ref('classes').once('value')
                    .then(snapshot => {
                        const data = snapshot.val();
                        classes = data ? Object.values(data) : [];
                        localStorage.setItem('classes', JSON.stringify(classes));
                        renderClassOptions();
                        renderClassTable();
                    })
                    .catch(error => {
                        console.error("Error loading classes:", error);
                        classes = [];
                        renderClassOptions();
                        renderClassTable();
                    });
            }

            function setupRealtimeListener() {
                database.ref('schedules').on('value', snapshot => {
                    const data = snapshot.val();
                    schedules = data ? Object.entries(data).map(([id, value]) => ({ id, ...value })) : [];
                    localStorage.setItem('schedules', JSON.stringify(schedules));
                    renderAllViews();
                    renderScheduleTable();
                });
                
                database.ref('teachers').on('value', snapshot => {
                    const data = snapshot.val();
                    teachers = data ? Object.values(data) : [];
                    localStorage.setItem('teachers', JSON.stringify(teachers));

                    teacherColorMap = {};
                    teachers.forEach(t => {
                        teacherColorMap[t.name] = t.color || getRandomColor();
                    });

                    renderTeacherOptions();
                    renderTeacherTable();
                    renderAllViews(); 
                });


                database.ref('subjects').on('value', snapshot => {
                    const data = snapshot.val();
                    subjects = data ? Object.values(data) : [];
                    localStorage.setItem('subjects', JSON.stringify(subjects));

                    subjectColorMap = {};
                    subjects.forEach(s => {
                        subjectColorMap[s.name] = s.color || getRandomColor();
                    });

                    renderSubjectOptions();
                    renderSubjectTable();
                    renderAllViews();
                });

                database.ref('locations').on('value', snapshot => {
                    const data = snapshot.val();
                    locations = data ? Object.values(data) : [];
                    localStorage.setItem('locations', JSON.stringify(locations));
                    renderLocationOptions();
                    renderLocationTable();
                    renderDailyView();
                });
                
                database.ref('classes').on('value', snapshot => {
                    const data = snapshot.val();
                    classes = data ? Object.values(data) : [];
                    localStorage.setItem('classes', JSON.stringify(classes));
                    renderClassOptions();
                    renderClassTable();
                });
            }

            // ====================
            // RENDER FUNCTIONS
            // ====================
            function renderAllViews() {
                renderDailyView();
                renderWeeklyView();
                renderMonthlyView();
            }
            
            function renderDailyView() {
                timeLabels.innerHTML = '';
                dailySchedule.innerHTML = '';

                const SLOT_HEIGHT = 20;

                const selectedDate = currentDateInput.valueAsDate || new Date();
                const selectedDateStr = selectedDate.toISOString().split('T')[0];
                const schedulesForDay = schedules.filter(s => s.date === selectedDateStr);

                let startHour = 7, endHour = 22;
                if (schedulesForDay.length > 0) {
                    let minMinutes = Infinity;
                    let maxMinutes = -Infinity;
                    schedulesForDay.forEach(schedule => {
                        const startParts = schedule.startTime.split(':').map(Number);
                        const endParts = schedule.endTime.split(':').map(Number);
                        minMinutes = Math.min(minMinutes, startParts[0] * 60 + startParts[1]);
                        maxMinutes = Math.max(maxMinutes, endParts[0] * 60 + endParts[1]);
                    });
                    startHour = Math.floor(minMinutes / 60);
                    endHour = Math.ceil(maxMinutes / 60) + 1;
                }
                startHour = Math.max(0, startHour);
                endHour = Math.min(24, endHour);
                if (startHour >= endHour) endHour = startHour + 1;
                
                const startMinutesTotal = startHour * 60;
                
                for (let hour = startHour; hour < endHour; hour++) {
                    for (let minute = 0; minute < 60; minute += 5) {
                        const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        const timeLabel = document.createElement('div');
                        timeLabel.className = 'time-slot flex items-center';
                        let labelText = '';
                        
                        if (minute === 0) {
                            timeLabel.classList.add('time-slot-hour');
                            labelText = `<div class="time-label pr-2 text-gray-700 text-sm time-label-hour">${time}</div>`;
                        } else if (minute === 30) {
                            timeLabel.classList.add('time-slot-half-hour');
                            labelText = `<div class="time-label pr-2 text-gray-500 text-xs">${time}</div>`;
                        } else {
                            labelText = `<div class="time-label pr-2 text-gray-400 flex justify-end items-center" style="font-size: 0.65rem;">
                                            <span class="tooltip-container">-<span class="tooltip-text">${time}</span></span>
                                        </div>`;
                        }
                        timeLabel.innerHTML = labelText;
                        timeLabels.appendChild(timeLabel);
                    }
                }

                const schedulesByInterval = new Map();
                schedulesForDay.forEach(schedule => {
                    const key = `${schedule.startTime}-${schedule.endTime}`;
                    if (!schedulesByInterval.has(key)) {
                        schedulesByInterval.set(key, []);
                    }
                    schedulesByInterval.get(key).push(schedule);
                });

                const sortedIntervals = [...schedulesByInterval.keys()].sort((a, b) => {
                    const [startA] = a.split('-');
                    const [startB] = b.split('-');
                    return startA.localeCompare(startB);
                });

                if (sortedIntervals.length === 0) {
                    dailySchedule.innerHTML = `<div class="p-4 text-gray-500 italic">Tidak ada jadwal untuk tanggal ini.</div>`;
                    return;
                }

                sortedIntervals.forEach(intervalKey => {
                    const [startTime, endTime] = intervalKey.split('-');
                    const schedulesInInterval = schedulesByInterval.get(intervalKey);
                    const cardCount = schedulesInInterval.length;

                    const scheduleColumn = document.createElement('div');
                    scheduleColumn.className = 'schedule-column';
                    scheduleColumn.dataset.startTime = startTime;
                    scheduleColumn.dataset.endTime = endTime;

                    if (cardCount > 0 && cardCount <= 3) {
                        const cardBaseWidth = 120;
                        const gap = 8;
                        const requiredWidth = (cardBaseWidth * cardCount) + (gap * (cardCount + 1));
                        scheduleColumn.style.width = `${requiredWidth}px`;
                        scheduleColumn.style.minWidth = `${requiredWidth}px`;
                    }

                    const header = document.createElement('div');
                    header.className = 'schedule-header';
                    header.textContent = `${startTime} - ${endTime}`;
                    scheduleColumn.appendChild(header);

                    const columnContent = document.createElement('div');
                    columnContent.className = 'schedule-column-content';
                    const totalGridHeight = (endHour - startHour) * 12 * SLOT_HEIGHT;
                    columnContent.style.minHeight = `${totalGridHeight}px`;

                    const startParts = startTime.split(':').map(Number);
                    const endParts = endTime.split(':').map(Number);
                    const startMinutes = startParts[0] * 60 + startParts[1];
                    const endMinutes = endParts[0] * 60 + endParts[1];
                    const startOffset = ((startMinutes - startMinutesTotal) / 5) * SLOT_HEIGHT;
                    const duration = Math.max(0, (((endMinutes - startMinutes) / 5) * SLOT_HEIGHT) - 2);
                    
                    if (cardCount > 3) {
                        const stackedCard = createStackedCard(schedulesInInterval, duration);
                        stackedCard.style.top = `${startOffset}px`;
                        columnContent.appendChild(stackedCard);
                    } else {
                        schedulesInInterval.forEach((schedule, index) => {
                            const scheduleElement = createScheduleCard(schedule, duration);
                            scheduleElement.style.top = `${startOffset}px`;
                            scheduleElement.style.width = `calc(${100 / cardCount}% - 8px)`;
                            scheduleElement.style.left = `calc(${index * (100 / cardCount)}% + 4px)`;
                            columnContent.appendChild(scheduleElement);
                        });
                    }
                    
                    columnContent.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        columnContent.classList.add('dropzone', 'active');
                    });
                    columnContent.addEventListener('dragleave', () => {
                        columnContent.classList.remove('active', 'invalid');
                    });
                    columnContent.addEventListener('drop', (e) => {
                        e.preventDefault();
                        columnContent.classList.remove('active');
                        if (!draggedSchedule) return;

                        const newStartTime = scheduleColumn.dataset.startTime;
                        const newEndTime = scheduleColumn.dataset.endTime;
                        
                        const updatedScheduleData = {
                            ...draggedSchedule.schedule,
                            startTime: newStartTime,
                            endTime: newEndTime,
                        };

                        if (checkScheduleConflict(updatedScheduleData, draggedSchedule.schedule.id)) {
                            columnContent.classList.add('invalid');
                            setTimeout(() => columnContent.classList.remove('invalid'), 500);
                            return;
                        }

                        database.ref('schedules/' + draggedSchedule.schedule.id).update({
                            startTime: newStartTime,
                            endTime: newEndTime,
                        }).then(() => {
                            Swal.fire({
                                toast: true, position: 'top-end', icon: 'success',
                                title: 'Jadwal berhasil dipindahkan',
                                showConfirmButton: false, timer: 1500
                            });
                        }).catch(error => {
                            console.error("Error moving schedule:", error);
                            Swal.fire('Gagal!', 'Terjadi kesalahan saat memindahkan jadwal.', 'error');
                        });
                    });

                    scheduleColumn.appendChild(columnContent);
                    dailySchedule.appendChild(scheduleColumn);
                });
            }

            function renderWeeklyView() {
                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                const weekSchedules = schedules.filter(schedule => {
                    const scheduleDate = new Date(schedule.date);
                    return scheduleDate >= currentWeekStart && scheduleDate <= weekEnd;
                });
                
                const teacherStats = {};
                weekSchedules.forEach(schedule => {
                    if (!teacherStats[schedule.teacher]) {
                        teacherStats[schedule.teacher] = {
                            hours: 0,
                            subjects: new Set(),
                            sessions: [],
                            color: getTeacherColor(schedule.teacher)
                        };
                    }
                    
                    const startParts = schedule.startTime.split(':');
                    const endParts = schedule.endTime.split(':');
                    const duration = (parseInt(endParts[0]) - parseInt(startParts[0])) + 
                                     (parseInt(endParts[1]) - parseInt(startParts[1])) / 60;
                    
                    teacherStats[schedule.teacher].hours += duration;
                    teacherStats[schedule.teacher].subjects.add(schedule.subject);
                    teacherStats[schedule.teacher].sessions.push({
                        date: schedule.date,
                        subject: schedule.subject,
                        startTime: schedule.startTime,
                        endTime: schedule.endTime,
                        duration: duration,
                        location: schedule.location
                    });
                });
                
                const subjectStats = {};
                weekSchedules.forEach(schedule => {
                    if (!subjectStats[schedule.subject]) {
                        subjectStats[schedule.subject] = {
                            hours: 0,
                            teachers: new Set(),
                            sessions: [],
                            color: getSubjectColor(schedule.subject)
                        };
                    }
                    
                    const startParts = schedule.startTime.split(':');
                    const endParts = schedule.endTime.split(':');
                    const duration = (parseInt(endParts[0]) - parseInt(startParts[0])) + 
                                     (parseInt(endParts[1]) - parseInt(startParts[1])) / 60;
                    
                    subjectStats[schedule.subject].hours += duration;
                    subjectStats[schedule.subject].teachers.add(schedule.teacher);
                    subjectStats[schedule.subject].sessions.push({
                        date: schedule.date,
                        teacher: schedule.teacher,
                        startTime: schedule.startTime,
                        endTime: schedule.endTime,
                        duration: duration,
                        location: schedule.location
                    });
                });
                
                const teachersSummary = document.getElementById('teachersSummary');
                teachersSummary.innerHTML = '';
                Object.entries(teacherStats).forEach(([teacher, stats]) => {
                    const teacherCard = document.createElement('div');
                    teacherCard.className = 'teacher-summary';
                    teacherCard.style.backgroundColor = stats.color;
                    teacherCard.style.color = getContrastColor(stats.color);
                    
                    teacherCard.innerHTML = `
                        <div class="font-bold">${teacher}</div>
                        <div class="text-sm mt-1">Total Jam: ${stats.hours.toFixed(1)} jam</div>
                        <div class="text-sm">Mata Pelajaran: ${[...stats.subjects].join(', ')}</div>
                    `;
                    
                    teacherCard.addEventListener('click', () => {
                        showTeacherDetail(teacher, stats);
                    });
                    
                    teachersSummary.appendChild(teacherCard);
                });
                
                const subjectsSummary = document.getElementById('subjectsSummary');
                subjectsSummary.innerHTML = '';
                Object.entries(subjectStats).forEach(([subject, stats]) => {
                    const subjectCard = document.createElement('div');
                    subjectCard.className = 'teacher-summary';
                    subjectCard.style.backgroundColor = stats.color;
                    subjectCard.style.color = getContrastColor(stats.color);
                    
                    subjectCard.innerHTML = `
                        <div class="font-bold">${subject}</div>
                        <div class="text-sm mt-1">Total Jam: ${stats.hours.toFixed(1)} jam</div>
                        <div class="text-sm">Pengajar: ${[...stats.teachers].join(', ')}</div>
                    `;
                    
                    subjectCard.addEventListener('click', () => {
                        showSubjectDetail(subject, stats);
                    });
                    
                    subjectsSummary.appendChild(subjectCard);
                });
            }

            function renderMonthlyView() {
                const monthlyCalendar = document.getElementById('monthlyCalendar');
                monthlyCalendar.innerHTML = '';

                const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
                const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);

                const firstDayOfWeek = firstDayOfMonth.getDay();
                const daysInMonth = lastDayOfMonth.getDate();

                const prevLastDay = new Date(currentYear, currentMonth, 0).getDate();
                for (let i = firstDayOfWeek; i > 0; i--) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'monthly-day bg-gray-100 p-1 border border-gray-200 text-gray-400';
                    dayCell.innerHTML = `<div class="font-medium text-right">${prevLastDay - i + 1}</div>`;
                    monthlyCalendar.appendChild(dayCell);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'monthly-day bg-white p-1 border border-gray-200 clickable-day';
                    dayCell.style.cursor = 'pointer';

                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'font-medium text-right mb-1';
                    dayHeader.textContent = day;
                    dayCell.appendChild(dayHeader);
                    
                    const yearStr = currentYear.toString();
                    const monthStr = (currentMonth + 1).toString().padStart(2, '0');
                    const dayStr = day.toString().padStart(2, '0');
                    const localDateStr = `${yearStr}-${monthStr}-${dayStr}`;

                    schedules.filter(s => s.date === localDateStr).forEach(event => {
                        const eventElement = document.createElement('div');
                        eventElement.className = 'monthly-event text-white p-1 mb-1 rounded truncate';
                        eventElement.style.backgroundColor = getTeacherColor(event.teacher);
                        eventElement.textContent = event.subject;
                        dayCell.appendChild(eventElement);
                    });
                    
                    dayCell.addEventListener('click', () => {
                        showDailySchedulePopup(localDateStr);
                    });

                    monthlyCalendar.appendChild(dayCell);
                }

                const lastDayOfWeek = lastDayOfMonth.getDay();
                const nextDays = 6 - lastDayOfWeek;
                for (let i = 1; i <= nextDays; i++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'monthly-day bg-gray-100 p-1 border border-gray-200 text-gray-400';
                    dayCell.innerHTML = `<div class="font-medium text-right">${i}</div>`;
                    monthlyCalendar.appendChild(dayCell);
                }
            }


            function renderScheduleTable() {
                const tableBody = document.getElementById('scheduleTableBody');
                tableBody.innerHTML = '';

                const config = paginationConfig.schedule;
                const selectAll = document.getElementById('scheduleSelectAll');
                const pagination = document.getElementById('schedulePagination');

                let filtered = schedules.filter(schedule =>
                    schedule.subject.toLowerCase().includes(config.searchTerm) ||
                    schedule.teacher.toLowerCase().includes(config.searchTerm) ||
                    schedule.location.toLowerCase().includes(config.searchTerm) ||
                    (schedule.class || '').toLowerCase().includes(config.searchTerm) ||
                    schedule.date.toLowerCase().includes(config.searchTerm) ||
                    `${schedule.startTime} - ${schedule.endTime}`.includes(config.searchTerm)
                );

                const fDate = document.getElementById('filterDate').value;
                const fTime = document.getElementById('filterTime').value.toLowerCase();
                const fSubject = document.getElementById('filterSubject').value.toLowerCase();
                const fTeacher = document.getElementById('filterTeacher').value.toLowerCase();
                const fLocation = document.getElementById('filterLocation').value.toLowerCase();
                const fClass = document.getElementById('filterClass').value.toLowerCase();

                filtered = filtered.filter(s =>
                    (!fDate || s.date === fDate) &&
                    (!fTime || `${s.startTime}-${s.endTime}`.toLowerCase().includes(fTime)) &&
                    (!fSubject || s.subject.toLowerCase().includes(fSubject)) &&
                    (!fTeacher || s.teacher.toLowerCase().includes(fTeacher)) &&
                    (!fLocation || s.location.toLowerCase().includes(fLocation)) &&
                    (!fClass || (s.class || '').toLowerCase().includes(fClass))
                );

                if (config.sortKey) {
                    filtered.sort((a, b) => {
                        const aVal = (a[config.sortKey] || '').toLowerCase();
                        const bVal = (b[config.sortKey] || '').toLowerCase();
                        if (aVal < bVal) return config.sortAsc ? -1 : 1;
                        if (aVal > bVal) return config.sortAsc ? 1 : -1;
                        return 0;
                    });
                } else {
                    filtered.sort((a, b) => (b.id > a.id) ? 1 : -1);
                }

                const totalPages = Math.ceil(filtered.length / config.entriesPerPage);
                const start = (config.currentPage - 1) * config.entriesPerPage;
                const end = start + config.entriesPerPage;
                const pageData = filtered.slice(start, end);

                pageData.forEach(schedule => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-2 border"><input type="checkbox" class="schedule-checkbox" data-id="${schedule.id}"></td>
                        <td class="p-2 border">${formatDateToDDMMYYYY(schedule.date)}</td>
                        <td class="p-2 border">${schedule.startTime} - ${schedule.endTime}</td>
                        <td class="p-2 border">${schedule.subject}</td>
                        <td class="p-2 border">${schedule.teacher}</td>
                        <td class="p-2 border">${schedule.location}</td>
                        <td class="p-2 border">${schedule.class || '-'}</td>
                        <td class="p-2 border">
                            <div class="action-btns">
                                <button class="bg-blue-500 text-white px-2 py-1 rounded text-xs edit-schedule-btn" data-id="${schedule.id}">Edit</button>
                                <button class="bg-red-500 text-white px-2 py-1 rounded text-xs delete-schedule-btn" data-id="${schedule.id}">Hapus</button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                document.querySelectorAll('.schedule-checkbox').forEach(cb => {
                    cb.addEventListener('change', updateDeleteSelectedScheduleButtonState);
                });

                if (selectAll) {
                    selectAll.checked = false;
                    selectAll.addEventListener('change', () => {
                        const all = document.querySelectorAll('.schedule-checkbox');
                        all.forEach(cb => cb.checked = selectAll.checked);
                        updateDeleteSelectedScheduleButtonState();
                    });
                }

                document.querySelectorAll('.edit-schedule-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        showEditModal(id);
                    });
                });

                document.querySelectorAll('.delete-schedule-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        showConfirmation('Anda yakin?', 'Jadwal ini akan dihapus secara permanen.', () => {
                            deleteSchedule(id);
                        });
                    });
                });

                renderPagination(pagination, config, totalPages, 'schedule');
                
                document.querySelectorAll('#scheduleTable thead th[data-sort]').forEach(th => {
                    const key = th.dataset.sort;
                    th.innerHTML = th.dataset.label || key;
                    if (config.sortKey === key) {
                        th.innerHTML += config.sortAsc ? ' ↑' : ' ↓';
                    }
                });
            }

            function renderTeacherTable() {
                const tableBody = document.getElementById('teacherTableBody');
                tableBody.innerHTML = '';

                const config = paginationConfig.teacher;
                const selectAll = document.getElementById('teacherSelectAll');
                const pagination = document.getElementById('teacherPagination');

                const filtered = teachers.filter(teacher =>
                    teacher.name.toLowerCase().includes(config.searchTerm) ||
                    (teacher.email || '').toLowerCase().includes(config.searchTerm) ||
                    (teacher.phone || '').toLowerCase().includes(config.searchTerm)
                );

                if (config.sortKey) {
                    filtered.sort((a, b) => {
                        const aVal = (a[config.sortKey] || '').toLowerCase();
                        const bVal = (b[config.sortKey] || '').toLowerCase();
                        if (aVal < bVal) return config.sortAsc ? -1 : 1;
                        if (aVal > bVal) return config.sortAsc ? 1 : -1;
                        return 0;
                    });
                } else {
                    filtered.sort((a, b) => (b.id > a.id) ? 1 : -1);
                }

                const totalPages = Math.ceil(filtered.length / config.entriesPerPage);
                const start = (config.currentPage - 1) * config.entriesPerPage;
                const end = start + config.entriesPerPage;
                const pageData = filtered.slice(start, end);

                pageData.forEach(teacher => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="checkbox" class="teacher-checkbox" data-id="${teacher.id}"></td>
                        <td>${teacher.name}</td>
                        <td>${teacher.email || '-'}</td>
                        <td>${teacher.phone || '-'}</td>
                        <td>
                            <div class="action-btns">
                                <button class="action-btn-table edit-btn edit-teacher-btn" data-id="${teacher.id}">Edit</button>
                                <button class="action-btn-table delete-btn delete-teacher-btn" data-id="${teacher.id}">Hapus</button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                document.querySelectorAll('.teacher-checkbox').forEach(cb => {
                    cb.addEventListener('change', updateDeleteSelectedTeacherButtonState);
                });

                if (selectAll) {
                    selectAll.addEventListener('change', () => {
                        document.querySelectorAll('.teacher-checkbox').forEach(cb => cb.checked = selectAll.checked);
                        updateDeleteSelectedTeacherButtonState();
                    });
                }

                document.querySelectorAll('.edit-teacher-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        showEditTeacherModal(id);
                    });
                });

                document.querySelectorAll('.delete-teacher-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        const teacherName = teachers.find(t=>t.id===id)?.name || 'ini';
                        showConfirmation('Anda Yakin?', `Pengajar "${teacherName}" akan dihapus.`, () => {
                            deleteTeacher(id);
                        });
                    });
                });

                renderPagination(pagination, config, totalPages, 'teacher');
                
                document.querySelectorAll('#teacherTable thead th[data-sort]').forEach(th => {
                    const key = th.dataset.sort;
                    th.innerHTML = th.dataset.label || key.charAt(0).toUpperCase() + key.slice(1);
                    if (config.sortKey === key) {
                        th.innerHTML += config.sortAsc ? ' ↑' : ' ↓';
                    }
                });
            }

            function renderSubjectTable() {
                const tableBody = document.getElementById('subjectTableBody');
                tableBody.innerHTML = '';

                const config = paginationConfig.subject;
                const selectAll = document.getElementById('subjectSelectAll');
                const pagination = document.getElementById('subjectPagination');

                const filtered = subjects.filter(subject =>
                    subject.name.toLowerCase().includes(config.searchTerm)
                );

                if (config.sortKey) {
                    filtered.sort((a, b) => {
                        const aVal = (a[config.sortKey] || '').toLowerCase();
                        const bVal = (b[config.sortKey] || '').toLowerCase();
                        if (aVal < bVal) return config.sortAsc ? -1 : 1;
                        if (aVal > bVal) return config.sortAsc ? 1 : -1;
                        return 0;
                    });
                } else {
                    filtered.sort((a, b) => (b.id > a.id) ? 1 : -1);
                }

                const totalPages = Math.ceil(filtered.length / config.entriesPerPage);
                const start = (config.currentPage - 1) * config.entriesPerPage;
                const end = start + config.entriesPerPage;
                const pageData = filtered.slice(start, end);

                pageData.forEach(subject => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-2 border"><input type="checkbox" class="subject-checkbox" data-id="${subject.id}"></td>
                        <td class="p-2 border">${subject.name}</td>
                        <td class="p-2 border">
                            <div class="action-btns">
                                <button class="action-btn-table edit-btn edit-subject-btn" data-id="${subject.id}">Edit</button>
                                <button class="action-btn-table delete-btn delete-subject-btn" data-id="${subject.id}">Hapus</button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                document.querySelectorAll('.subject-checkbox').forEach(cb => {
                    cb.addEventListener('change', updateDeleteSelectedSubjectButtonState);
                });

                if (selectAll) {
                    selectAll.addEventListener('change', () => {
                        document.querySelectorAll('.subject-checkbox').forEach(cb => cb.checked = selectAll.checked);
                        updateDeleteSelectedSubjectButtonState();
                    });
                }

                document.querySelectorAll('.edit-subject-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        showEditSubjectModal(id);
                    });
                });

                document.querySelectorAll('.delete-subject-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        const subjectName = subjects.find(s=>s.id===id)?.name || 'ini';
                        showConfirmation('Anda Yakin?', `Mata pelajaran "${subjectName}" akan dihapus.`, () => {
                            deleteSubject(id);
                        });
                    });
                });

                renderPagination(pagination, config, totalPages, 'subject');
                
                document.querySelectorAll('#subjectTable thead th[data-sort]').forEach(th => {
                    const key = th.dataset.sort;
                    th.innerHTML = th.dataset.label || key;
                    if (config.sortKey === key) {
                        th.innerHTML += config.sortAsc ? ' ↑' : ' ↓';
                    }
                });
            }

            function renderLocationTable() {
                const tableBody = document.getElementById('locationTableBody');
                tableBody.innerHTML = '';

                const config = paginationConfig.location;
                const selectAll = document.getElementById('locationSelectAll');
                const pagination = document.getElementById('locationPagination');

                const filtered = locations.filter(location =>
                    location.name.toLowerCase().includes(config.searchTerm)
                );

                if (config.sortKey) {
                    filtered.sort((a, b) => {
                        const aVal = (a[config.sortKey] || '').toLowerCase();
                        const bVal = (b[config.sortKey] || '').toLowerCase();
                        if (aVal < bVal) return config.sortAsc ? -1 : 1;
                        if (aVal > bVal) return config.sortAsc ? 1 : -1;
                        return 0;
                    });
                } else {
                    filtered.sort((a, b) => (b.id > a.id) ? 1 : -1);
                }

                const totalPages = Math.ceil(filtered.length / config.entriesPerPage);
                const start = (config.currentPage - 1) * config.entriesPerPage;
                const end = start + config.entriesPerPage;
                const pageData = filtered.slice(start, end);

                pageData.forEach(location => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-2 border"><input type="checkbox" class="location-checkbox" data-id="${location.id}"></td>
                        <td class="p-2 border">${location.name}</td>
                        <td class="p-2 border">
                            <div class="action-btns">
                                <button class="bg-blue-500 text-white px-2 py-1 rounded text-xs edit-location-btn" data-id="${location.id}">Edit</button>
                                <button class="bg-red-500 text-white px-2 py-1 rounded text-xs delete-location-btn" data-id="${location.id}">Hapus</button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                document.querySelectorAll('.location-checkbox').forEach(cb => {
                    cb.addEventListener('change', updateDeleteSelectedLocationButtonState);
                });

                if (selectAll) {
                    selectAll.addEventListener('change', () => {
                        document.querySelectorAll('.location-checkbox').forEach(cb => cb.checked = selectAll.checked);
                        updateDeleteSelectedLocationButtonState();
                    });
                }

                document.querySelectorAll('.edit-location-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        showEditLocationModal(id);
                    });
                });

                document.querySelectorAll('.delete-location-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        const locationName = locations.find(l=>l.id===id)?.name || 'ini';
                        showConfirmation('Anda Yakin?', `Lokasi "${locationName}" akan dihapus.`, () => {
                            deleteLocation(id);
                        });
                    });
                });

                renderPagination(pagination, config, totalPages, 'location');
                
                document.querySelectorAll('#locationTable thead th[data-sort]').forEach(th => {
                    const key = th.dataset.sort;
                    th.innerHTML = th.dataset.label || key;
                    if (config.sortKey === key) {
                        th.innerHTML += config.sortAsc ? ' ↑' : ' ↓';
                    }
                });
            }

            function renderClassTable() {
                const tableBody = document.getElementById('classTableBody');
                tableBody.innerHTML = '';

                const config = paginationConfig.class;
                const selectAll = document.getElementById('classSelectAll');
                const pagination = document.getElementById('classPagination');

                const filtered = classes.filter(cls =>
                    cls.name.toLowerCase().includes(config.searchTerm)
                );

                if (config.sortKey) {
                    filtered.sort((a, b) => {
                        const aVal = (a[config.sortKey] || '').toLowerCase();
                        const bVal = (b[config.sortKey] || '').toLowerCase();
                        if (aVal < bVal) return config.sortAsc ? -1 : 1;
                        if (aVal > bVal) return config.sortAsc ? 1 : -1;
                        return 0;
                    });
                } else {
                    filtered.sort((a, b) => (b.id > a.id) ? 1 : -1);
                }

                const totalPages = Math.ceil(filtered.length / config.entriesPerPage);
                const start = (config.currentPage - 1) * config.entriesPerPage;
                const end = start + config.entriesPerPage;
                const pageData = filtered.slice(start, end);

                pageData.forEach(cls => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-2 border"><input type="checkbox" class="class-checkbox" data-id="${cls.id}"></td>
                        <td class="p-2 border">${cls.name}</td>
                        <td class="p-2 border">
                            <div class="action-btns">
                                <button class="bg-blue-500 text-white px-2 py-1 rounded text-xs edit-class-btn" data-id="${cls.id}">Edit</button>
                                <button class="bg-red-500 text-white px-2 py-1 rounded text-xs delete-class-btn" data-id="${cls.id}">Hapus</button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                document.querySelectorAll('.class-checkbox').forEach(cb => {
                    cb.addEventListener('change', updateDeleteSelectedClassButtonState);
                });

                if (selectAll) {
                    selectAll.addEventListener('change', () => {
                        document.querySelectorAll('.class-checkbox').forEach(cb => cb.checked = selectAll.checked);
                        updateDeleteSelectedClassButtonState();
                    });
                }

                document.querySelectorAll('.edit-class-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        showEditClassModal(id);
                    });
                });

                document.querySelectorAll('.delete-class-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        const className = classes.find(c=>c.id===id)?.name || 'ini';
                        showConfirmation('Anda Yakin?', `Kelas "${className}" akan dihapus.`, () => {
                            deleteClass(id);
                        });
                    });
                });

                renderPagination(pagination, config, totalPages, 'class');
                
                document.querySelectorAll('#classTable thead th[data-sort]').forEach(th => {
                    const key = th.dataset.sort;
                    th.innerHTML = th.dataset.label || key;
                    if (config.sortKey === key) {
                        th.innerHTML += config.sortAsc ? ' ↑' : ' ↓';
                    }
                });
            }

            function renderPagination(container, config, totalPages, type) {
                container.innerHTML = '';

                const start = (config.currentPage - 1) * config.entriesPerPage;
                const end = start + config.entriesPerPage;
                const filtered = getFilteredData(type);

                const paginationInfo = document.createElement('div');
                paginationInfo.classList.add('text-gray-600');
                paginationInfo.textContent = `Menampilkan ${filtered.length === 0 ? 0 : start + 1}–${Math.min(end, filtered.length)} dari ${filtered.length} data`;

                const paginationNav = document.createElement('div');
                paginationNav.classList.add('flex', 'gap-1', 'items-center');

                const prevBtn = document.createElement('button');
                prevBtn.textContent = '«';
                prevBtn.className = 'px-2 py-1 border rounded';
                prevBtn.disabled = config.currentPage === 1;
                prevBtn.addEventListener('click', () => {
                    config.currentPage--;
                    renderTable(type);
                });
                paginationNav.appendChild(prevBtn);

                for (let i = 1; i <= totalPages; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = 'px-2 py-1 border rounded';
                    if (i === config.currentPage) {
                        pageBtn.classList.add('bg-indigo-600', 'text-white', 'font-semibold');
                    }
                    pageBtn.addEventListener('click', () => {
                        config.currentPage = i;
                        renderTable(type);
                    });
                    paginationNav.appendChild(pageBtn);
                }

                const nextBtn = document.createElement('button');
                nextBtn.textContent = '»';
                nextBtn.className = 'px-2 py-1 border rounded';
                nextBtn.disabled = config.currentPage === totalPages || totalPages === 0;
                nextBtn.addEventListener('click', () => {
                    config.currentPage++;
                    renderTable(type);
                });
                paginationNav.appendChild(nextBtn);

                container.appendChild(paginationInfo);
                container.appendChild(paginationNav);
            }

            function getFilteredData(type) {
                const config = paginationConfig[type];
                let data;
                
                switch(type) {
                    case 'schedule': data = schedules; break;
                    case 'teacher': data = teachers; break;
                    case 'subject': data = subjects; break;
                    case 'location': data = locations; break;
                    case 'class': data = classes; break;
                    default: return [];
                }
                
                return data.filter(item => {
                    if (type === 'schedule') {
                        return (
                            item.subject.toLowerCase().includes(config.searchTerm) ||
                            item.teacher.toLowerCase().includes(config.searchTerm) ||
                            item.location.toLowerCase().includes(config.searchTerm) ||
                            item.class?.toLowerCase().includes(config.searchTerm) ||
                            item.date.toLowerCase().includes(config.searchTerm) ||
                            `${item.startTime} - ${item.endTime}`.includes(config.searchTerm)
                        );
                    } else if (type === 'teacher') {
                        return (
                            item.name.toLowerCase().includes(config.searchTerm) ||
                            (item.email || '').toLowerCase().includes(config.searchTerm) ||
                            (item.phone || '').toLowerCase().includes(config.searchTerm)
                        );
                    } else {
                        return item.name.toLowerCase().includes(config.searchTerm);
                    }
                });
            }

            function renderTable(type) {
                switch(type) {
                    case 'schedule': renderScheduleTable(); break;
                    case 'teacher': renderTeacherTable(); break;
                    case 'subject': renderSubjectTable(); break;
                    case 'location': renderLocationTable(); break;
                    case 'class': renderClassTable(); break;
                }
            }

            // ====================
            // OPTION RENDERERS
            // ====================
            function renderTeacherOptions() {
                let options = '<option value="">Pilih Pengajar</option>';
                teachers.forEach(teacher => {
                    options += `<option value="${teacher.name}">${teacher.name}</option>`;
                });
                teacherName.innerHTML = options;
                editTeacherName.innerHTML = options;
            }

            function renderSubjectOptions() {
                let options = '<option value="">Pilih Mata Pelajaran</option>';
                subjects.forEach(subject => {
                    options += `<option value="${subject.name}">${subject.name}</option>`;
                });
                subjectName.innerHTML = options;
                editSubjectName.innerHTML = options;
            }

            function renderLocationOptions() {
                let options = '<option value="">Pilih Lokasi/Ruang</option>';
                locations.forEach(location => {
                    options += `<option value="${location.name}">${location.name}</option>`;
                });
                location.innerHTML = options;
                editLocation.innerHTML = options;
            }

            function renderClassOptions() {
                let options = '<option value="">Pilih Kelas</option>';
                classes.forEach(classItem => {
                    options += `<option value="${classItem.name}">${classItem.name}</option>`;
                });
                className.innerHTML = options;
                editClassName.innerHTML = options;
            }

            // ====================
            // UI COMPONENTS
            // ====================
            function showDailySchedulePopup(dateStr) {
                const schedulesForDay = schedules
                    .filter(s => s.date === dateStr)
                    .sort((a, b) => a.startTime.localeCompare(b.startTime));

                const dateParts = dateStr.split('-');
                const displayDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);

                const formattedDate = displayDate.toLocaleDateString('id-ID', {
                    weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
                });

                let contentHtml = '';
                if (schedulesForDay.length === 0) {
                    contentHtml = '<div class="text-center text-gray-500 py-4">Tidak ada jadwal pada tanggal ini.</div>';
                } else {
                    contentHtml = schedulesForDay.map(s => `
                        <div class="border-b last:border-b-0 p-3 text-left">
                            <div class="font-semibold text-indigo-700">${s.subject}</div>
                            <div class="text-sm text-gray-600">${s.startTime} - ${s.endTime}</div>
                            <div class="text-xs text-gray-500 mt-1">
                                👨‍🏫 ${s.teacher} | 📍 ${s.location} | 🏫 ${s.class || ''}
                            </div>
                        </div>
                    `).join('');
                }

                Swal.fire({
                    title: `<span style="font-size: 1.25rem;">Jadwal untuk ${formattedDate}</span>`,
                    html: `<div class="max-h-96 overflow-y-auto">${contentHtml}</div>`,
                    width: '600px',
                    showCloseButton: true,
                    showConfirmButton: false
                });
            }
            
            function createScheduleCard(schedule, height) {
                const scheduleElement = document.createElement('div');
                scheduleElement.className = 'subject-card draggable-card';
                scheduleElement.style.backgroundColor = getTeacherColor(schedule.teacher);
                scheduleElement.style.color = getContrastColor(getTeacherColor(schedule.teacher));
                scheduleElement.style.height = `${height}px`;
                
                scheduleElement.innerHTML = `
                    <div class="font-semibold text-sm whitespace-normal">${schedule.subject}</div>
                    <div class="text-xs whitespace-normal">${schedule.teacher}</div>
                    <div class="text-xs whitespace-normal">${schedule.class || ''}</div>
                    <div class="text-xs whitespace-normal mt-1">📍 ${schedule.location}</div>
                    <div class="card-actions">
                        <div class="action-btn edit" data-id="${schedule.id}">✏️</div>
                        <div class="action-btn delete" data-id="${schedule.id}">🗑️</div>
                    </div>
                `;
                
                scheduleElement.draggable = true;
                scheduleElement.dataset.id = schedule.id;
                
                scheduleElement.addEventListener('dragstart', (e) => {
                    draggedSchedule = {
                        element: scheduleElement,
                        schedule: schedule
                    };
                    scheduleElement.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', schedule.id);
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                scheduleElement.addEventListener('dragend', () => {
                    scheduleElement.classList.remove('dragging');
                });
                
                scheduleElement.querySelector('.action-btn.edit').addEventListener('click', (e) => {
                    e.stopPropagation();
                    showEditModal(schedule.id);
                });
                
                scheduleElement.querySelector('.action-btn.delete').addEventListener('click', (e) => {
                    e.stopPropagation();
                    showConfirmation('Anda Yakin?', 'Jadwal ini akan dihapus permanen.', () => {
                        deleteSchedule(schedule.id);
                    });
                });
                
                return scheduleElement;
            }

            function createStackedCard(schedules, height) {
                const card = document.createElement('div');
                card.className = 'stacked-summary-card';
                card.style.height = `${height}px`;
                card.style.width = 'calc(100% - 8px)';
                card.style.left = '4px';

                card.innerHTML = `<div class="font-bold text-lg">${schedules.length} Jadwal</div>`;
                
                card.addEventListener('click', () => {
                    showStackedSchedulesModal(schedules);
                });

                return card;
            }

            function showStackedSchedulesModal(schedules) {
                const stackedScheduleContent = document.getElementById('stackedScheduleContent');
                stackedScheduleContent.innerHTML = '';
                
                const modalTitle = document.getElementById('stackedScheduleModalLabel');
                const firstSchedule = schedules[0];
                modalTitle.textContent = `Jadwal ${firstSchedule.startTime} - ${firstSchedule.endTime}`;
                
                schedules.forEach((schedule) => {
                    const card = document.createElement('div');
                    card.className = 'schedule-card-modal p-3 stacked-card';
                    card.style.backgroundColor = getTeacherColor(schedule.teacher);
                    card.style.color = getContrastColor(getTeacherColor(schedule.teacher));
                    
                    card.innerHTML = `
                        <div class="fw-bold mb-1">${schedule.subject}</div>
                        <div class="mb-1">Pengajar: ${schedule.teacher}</div>
                        <div class="mb-1">Ruang: ${schedule.location}</div>
                        <div class="mb-1">Kelas: ${schedule.class || '-'}</div>
                        <div class="d-flex gap-2 mt-2">
                            <button class="btn btn-sm btn-light btn-edit" data-id="${schedule.id}">Edit</button>
                            <button class="btn btn-sm btn-danger btn-delete" data-id="${schedule.id}">Hapus</button>
                        </div>
                    `;
                    
                    stackedScheduleContent.appendChild(card);
                });
                
                stackedScheduleContent.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        stackedScheduleModal.hide();
                        showEditModal(id);
                    });
                });
                
                stackedScheduleContent.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        showConfirmation('Anda Yakin?', 'Jadwal ini akan dihapus permanen.', () => {
                            deleteSchedule(id);
                            stackedScheduleModal.hide();
                        });
                    });
                });
                
                stackedScheduleModal.show();
            }

            function showTeacherDetail(teacher, stats) {
                const modalContent = `
                    <div class="modal-header" style="border-bottom-color: ${stats.color}">
                        <h5 class="modal-title" style="color: ${stats.color}">Detail Pengajar: ${teacher}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-4">
                            <h4 class="font-semibold text-lg mb-2">Total Jam Mengajar: ${stats.hours.toFixed(1)} jam</h4>
                            <h4 class="font-semibold mb-2">Sesi Mengajar:</h4>
                            <div class="space-y-2">
                                ${getTeacherSessionsHtml(stats)}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    </div>
                `;

                document.getElementById('detailModalContent').innerHTML = modalContent;

                const modal = new bootstrap.Modal(document.getElementById('detailModal'));
                modal.show();
            }


            function getTeacherSessionsHtml(stats) {
                let html = '';
                
                stats.sessions.sort((a, b) => {
                    const dateCompare = new Date(a.date) - new Date(b.date);
                    if (dateCompare !== 0) return dateCompare;
                    return a.startTime.localeCompare(b.startTime);
                });
                
                const sessionsByDate = {};
                stats.sessions.forEach(session => {
                    if (!sessionsByDate[session.date]) {
                        sessionsByDate[session.date] = [];
                    }
                    sessionsByDate[session.date].push(session);
                });
                
                Object.entries(sessionsByDate).forEach(([date, sessions]) => {
                    const dateObj = new Date(date + "T00:00:00");
                    const dateStr = dateObj.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });
                    
                    html += `<div class="border-b pb-2 mb-2">
                        <div class="font-medium">${dateStr}</div>`;
                    
                    sessions.forEach(session => {
                        const color = getSubjectColor(session.subject);
                        html += `<div class="pl-4 py-1">
                            <span class="subject-badge" style="background-color: ${color}; color: ${getContrastColor(color)}">${session.subject}</span>
                            <span>${session.startTime} - ${session.endTime} (${session.duration.toFixed(1)} jam)</span>
                            <div class="text-xs text-gray-500">${session.location}</div>
                        </div>`;
                    });
                    
                    html += `</div>`;
                });
                
                return html;
            }

            function showSubjectDetail(subject, stats) {
                const modalContent = `
                    <div class="modal-header" style="border-bottom-color: ${stats.color}">
                        <h5 class="modal-title" style="color: ${stats.color}">Detail Mata Pelajaran: ${subject}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-4">
                            <h4 class="font-semibold text-lg mb-2">Total Jam: ${stats.hours.toFixed(1)} jam</h4>
                            <h4 class="font-semibold mb-2">Sesi Pembelajaran:</h4>
                            <div class="space-y-2">
                                ${getSubjectSessionsHtml(stats)}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    </div>
                `;

                document.getElementById('detailModalContent').innerHTML = modalContent;

                const modal = new bootstrap.Modal(document.getElementById('detailModal'));
                modal.show();
            }


            function getSubjectSessionsHtml(stats) {
                let html = '';
                
                stats.sessions.sort((a, b) => {
                    const dateCompare = new Date(a.date) - new Date(b.date);
                    if (dateCompare !== 0) return dateCompare;
                    return a.startTime.localeCompare(b.startTime);
                });
                
                const sessionsByDate = {};
                stats.sessions.forEach(session => {
                    if (!sessionsByDate[session.date]) {
                        sessionsByDate[session.date] = [];
                    }
                    sessionsByDate[session.date].push(session);
                });
                
                Object.entries(sessionsByDate).forEach(([date, sessions]) => {
                    const dateObj = new Date(date + "T00:00:00");
                    const dateStr = dateObj.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });
                    
                    html += `<div class="border-b pb-2 mb-2">
                        <div class="font-medium">${dateStr}</div>`;
                    
                    sessions.forEach(session => {
                        const teacherColor = getTeacherColor(session.teacher);
                        html += `<div class="pl-4 py-1">
                            <span class="font-medium">${session.teacher}</span>
                            <span>${session.startTime} - ${session.endTime} (${session.duration.toFixed(1)} jam)</span>
                            <div class="text-xs text-gray-500">${session.location}</div>
                        </div>`;
                    });
                    
                    html += `</div>`;
                });
                
                return html;
            }

            // ====================
            // CRUD OPERATIONS
            // ====================
            function addNewSchedule() {
                const newSchedule = {
                    id: Date.now().toString(),
                    date: scheduleDateInput.value,
                    startTime: startTimeInput.value,
                    endTime: endTimeInput.value,
                    subject: subjectName.value,
                    teacher: teacherName.value,
                    location: location.value,
                    class: className.value
                };

                if (!isTimeMultipleOfFive(newSchedule.startTime) || !isTimeMultipleOfFive(newSchedule.endTime)) {
                    Swal.fire('Gagal!', 'Waktu harus dalam kelipatan 5 menit (contoh: 08:05, 09:10).', 'error');
                    return;
                }

                if (newSchedule.startTime >= newSchedule.endTime) {
                    Swal.fire('Gagal!', 'Waktu selesai harus setelah waktu mulai.', 'error');
                    return;
                }

                if (!newSchedule.subject || !newSchedule.teacher || !newSchedule.location || !newSchedule.class) {
                    Swal.fire('Gagal!', 'Semua field wajib diisi.', 'warning');
                    return;
                }

                if (checkScheduleConflict(newSchedule)) return;

                database.ref('schedules/' + newSchedule.id).set(newSchedule)
                    .then(() => {
                        Swal.fire('Berhasil!', 'Jadwal baru berhasil ditambahkan.', 'success');
                        scheduleForm.reset();
                        scheduleDateInput.value = newSchedule.date;
                    })
                    .catch(error => {
                        console.error("Error adding schedule:", error);
                        Swal.fire('Gagal!', 'Terjadi kesalahan saat menambahkan jadwal.', 'error');
                    });
            }

            function checkScheduleConflict(newSchedule, excludeId = null) {
                const startTime = newSchedule.startTime;
                const endTime = newSchedule.endTime;
                const date = newSchedule.date;
                const teacher = newSchedule.teacher;
                const location = newSchedule.location;

                const teacherConflict = schedules.some(schedule => {
                    if (schedule.id === excludeId) return false;
                    return schedule.date === date && 
                        schedule.teacher === teacher &&
                        ((startTime >= schedule.startTime && startTime < schedule.endTime) ||
                            (endTime > schedule.startTime && endTime <= schedule.endTime) ||
                            (startTime <= schedule.startTime && endTime >= schedule.endTime));
                });

                if (teacherConflict) {
                    showConflictNotification(`Pengajar ${teacher} sudah memiliki jadwal pada waktu tersebut`);
                    return true;
                }

                const locationConflict = schedules.some(schedule => {
                    if (schedule.id === excludeId) return false;
                    return schedule.date === date && 
                        schedule.location === location &&
                        ((startTime >= schedule.startTime && startTime < schedule.endTime) ||
                            (endTime > schedule.startTime && endTime <= schedule.endTime) ||
                            (startTime <= schedule.startTime && endTime >= schedule.endTime));
                });

                if (locationConflict) {
                    showConflictNotification(`Ruangan ${location} sudah digunakan pada waktu tersebut`);
                    return true;
                }

                return false;
            }

            function deleteSchedule(id) {
                database.ref('schedules/' + id).remove()
                    .then(() => {
                        Swal.fire('Berhasil!', 'Jadwal berhasil dihapus.', 'success');
                    })
                    .catch(error => {
                        console.error('Error deleting schedule:', error);
                        Swal.fire('Gagal', 'Terjadi kesalahan saat menghapus jadwal.', 'error');
                    });
            }

            function showEditModal(id) {
                const schedule = schedules.find(s => s.id === id);
                
                if (schedule) {
                    editScheduleId.value = schedule.id;
                    editScheduleDate.value = schedule.date;
                    editStartTimeInput.value = schedule.startTime;
                    editEndTimeInput.value = schedule.endTime;
                    editSubjectName.value = schedule.subject;
                    editTeacherName.value = schedule.teacher;
                    editLocation.value = schedule.location;
                    editClassName.value = schedule.class || '';
                    
                    editModal.classList.remove('hidden');
                }
            }

            function updateSchedule() {
                const id = editScheduleId.value;

                const updatedSchedule = {
                    id: id,
                    date: editScheduleDate.value,
                    startTime: editStartTimeInput.value,
                    endTime: editEndTimeInput.value,
                    subject: editSubjectName.value,
                    teacher: editTeacherName.value,
                    location: editLocation.value,
                    class: editClassName.value
                };
                
                if (!isTimeMultipleOfFive(updatedSchedule.startTime) || !isTimeMultipleOfFive(updatedSchedule.endTime)) {
                    Swal.fire('Gagal!', 'Waktu harus dalam kelipatan 5 menit (contoh: 08:05, 09:10).', 'error');
                    return;
                }

                if (updatedSchedule.startTime >= updatedSchedule.endTime) {
                    Swal.fire('Gagal!', 'Waktu selesai harus setelah waktu mulai.', 'error');
                    return;
                }

                if (checkScheduleConflict(updatedSchedule, id)) return;

                database.ref('schedules/' + id).update(updatedSchedule)
                    .then(() => {
                        Swal.fire('Berhasil!', 'Jadwal berhasil diperbarui.', 'success');
                        editModal.classList.add('hidden');
                    })
                    .catch(error => {
                        console.error("Error updating schedule:", error);
                        Swal.fire('Gagal!', 'Terjadi kesalahan saat memperbarui jadwal.', 'error');
                    });
            }


            function addNewTeacher() {
                const newTeacher = {
                    id: database.ref().push().key,
                    name: document.getElementById('teacherNameInput').value.trim(),
                    email: document.getElementById('teacherEmailInput').value.trim(),
                    phone: document.getElementById('teacherPhoneInput').value.trim(),
                    color: getRandomColor()
                };

                if (!newTeacher.name) {
                    Swal.fire('Gagal!', 'Nama pengajar harus diisi.', 'warning');
                    return;
                }

                database.ref('teachers/' + newTeacher.id).set(newTeacher)
                    .then(() => {
                        Swal.fire('Berhasil!', 'Pengajar berhasil ditambahkan.', 'success');
                        document.getElementById('teacherForm').reset();
                    })
                    .catch(error => {
                        console.error('Error adding teacher:', error);
                        Swal.fire('Gagal', 'Terjadi kesalahan saat menambahkan pengajar.', 'error');
                    });
            }

            function showEditTeacherModal(id) {
                database.ref('teachers/' + id).once('value')
                    .then(snapshot => {
                        const teacher = snapshot.val();
                        if (teacher) {
                            document.getElementById('editTeacherId').value = teacher.id;
                            document.getElementById('editTeacherNameInput').value = teacher.name;
                            document.getElementById('editTeacherEmailInput').value = teacher.email || '';
                            document.getElementById('editTeacherPhoneInput').value = teacher.phone || '';
                            
                            document.getElementById('editTeacherModal').classList.remove('hidden');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching teacher:', error);
                    });
            }

            function updateTeacher() {
                const id = document.getElementById('editTeacherId').value;
                const updatedTeacher = {
                    id: id,
                    name: document.getElementById('editTeacherNameInput').value.trim(),
                    email: document.getElementById('editTeacherEmailInput').value.trim(),
                    phone: document.getElementById('editTeacherPhoneInput').value.trim()
                };

                if (!updatedTeacher.name) {
                    Swal.fire('Gagal!', 'Nama pengajar harus diisi.', 'warning');
                    return;
                }

                database.ref('teachers/' + id).update(updatedTeacher)
                    .then(() => {
                        Swal.fire('Berhasil!', 'Data pengajar berhasil diperbarui.', 'success');
                        document.getElementById('editTeacherModal').classList.add('hidden');
                    })
                    .catch(error => {
                        console.error('Error updating teacher:', error);
                        Swal.fire('Gagal', 'Terjadi kesalahan saat memperbarui pengajar.', 'error');
                    });
            }

            function deleteTeacher(id) {
                database.ref('teachers/' + id).remove()
                    .then(() => {
                        Swal.fire('Berhasil!', 'Pengajar berhasil dihapus.', 'success');
                    })
                    .catch(error => {
                        console.error('Error deleting teacher:', error);
                        Swal.fire('Gagal', 'Terjadi kesalahan saat menghapus pengajar.', 'error');
                    });
            }

            function addNewSubject() {
                const newSubject = {
                    id: database.ref().push().key,
                    name: document.getElementById('subjectNameInput').value.trim(),
                    color: getRandomColor()
                };

                if (!newSubject.name) {
                    Swal.fire('Gagal!', 'Nama mata pelajaran harus diisi.', 'warning');
                    return;
                }

                database.ref('subjects/' + newSubject.id).set(newSubject)
                    .then(() => {
                        Swal.fire('Berhasil!', 'Mata pelajaran berhasil ditambahkan.', 'success');
                        document.getElementById('subjectForm').reset();
                    })
                    .catch(error => {
                        console.error('Error adding subject:', error);
                        Swal.fire('Gagal', 'Terjadi kesalahan saat menambahkan mata pelajaran.', 'error');
                    });
            }

            function showEditSubjectModal(id) {
                database.ref('subjects/' + id).once('value')
                    .then(snapshot => {
                        const subject = snapshot.val();
                        if (subject) {
                            document.getElementById('editSubjectId').value = subject.id;
                            document.getElementById('editSubjectNameInput').value = subject.name;
                            
                            document.getElementById('editSubjectModal').classList.remove('hidden');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching subject:', error);
                    });
            }

            function updateSubject() {
                const id = document.getElementById('editSubjectId').value;
                const updatedSubject = {
                    id: id,
                    name: document.getElementById('editSubjectNameInput').value.trim()
                };

                if (!updatedSubject.name) {
                    Swal.fire('Gagal!', 'Nama mata pelajaran harus diisi.', 'warning');
                    return;
                }

                database.ref('subjects/' + id).update(updatedSubject)
                    .then(() => {
                        Swal.fire('Berhasil!', 'Data mata pelajaran berhasil diperbarui.', 'success');
                        document.getElementById('editSubjectModal').classList.add('hidden');
                    })
                    .catch(error => {
                        console.error('Error updating subject:', error);
                        Swal.fire('Gagal', 'Terjadi kesalahan saat memperbarui mata pelajaran.', 'error');
                    });
            }

            function deleteSubject(id) {
                database.ref('subjects/' + id).remove()
                    .then(() => {
                        Swal.fire('Berhasil!', 'Mata pelajaran berhasil dihapus.', 'success');
                    })
                    .catch(error => {
                        console.error('Error deleting subject:', error);
                        Swal.fire('Gagal', 'Terjadi kesalahan saat menghapus mata pelajaran.', 'error');
                    });
            }

            function addNewLocation() {
                const newLocation = {
                    id: database.ref().push().key,
                    name: document.getElementById('locationNameInput').value.trim()
                };

                if (!newLocation.name) {
                    Swal.fire('Gagal!', 'Nama lokasi/ruang harus diisi.', 'warning');
                    return;
                }

                database.ref('locations/' + newLocation.id).set(newLocation)
                    .then(() => {
                        Swal.fire('Berhasil!', 'Lokasi/ruang berhasil ditambahkan.', 'success');
                        document.getElementById('locationForm').reset();
                    })
                    .catch(error => {
                        console.error('Error adding location:', error);
                        Swal.fire('Gagal', 'Terjadi kesalahan saat menambahkan lokasi/ruang.', 'error');
                    });
            }

            function showEditLocationModal(id) {
                database.ref('locations/' + id).once('value')
                    .then(snapshot => {
                        const location = snapshot.val();
                        if (location) {
                            document.getElementById('editLocationId').value = location.id;
                            document.getElementById('editLocationNameInput').value = location.name;
                            
                            document.getElementById('editLocationModal').classList.remove('hidden');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching location:', error);
                    });
            }

            function updateLocation() {
                const id = document.getElementById('editLocationId').value;
                const updatedLocation = {
                    id: id,
                    name: document.getElementById('editLocationNameInput').value.trim()
                };

                if (!updatedLocation.name) {
                    Swal.fire('Gagal!', 'Nama lokasi/ruang harus diisi.', 'warning');
                    return;
                }

                database.ref('locations/' + id).update(updatedLocation)
                    .then(() => {
                        Swal.fire('Berhasil!', 'Data lokasi/ruang berhasil diperbarui.', 'success');
                        document.getElementById('editLocationModal').classList.add('hidden');
                    })
                    .catch(error => {
                        console.error('Error updating location:', error);
                        Swal.fire('Gagal', 'Terjadi kesalahan saat memperbarui lokasi/ruang.', 'error');
                    });
            }

            function deleteLocation(id) {
                database.ref('locations/' + id).remove()
                    .then(() => {
                        Swal.fire('Berhasil!', 'Lokasi/ruang berhasil dihapus.', 'success');
                    })
                    .catch(error => {
                        console.error('Error deleting location:', error);
                        Swal.fire('Gagal', 'Terjadi kesalahan saat menghapus lokasi/ruang.', 'error');
                    });
            }

            function addNewClass() {
                const newClass = {
                    id: database.ref().push().key,
                    name: document.getElementById('classNameInput').value.trim()
                };

                if (!newClass.name) {
                    Swal.fire('Gagal!', 'Nama kelas harus diisi.', 'warning');
                    return;
                }

                database.ref('classes/' + newClass.id).set(newClass)
                    .then(() => {
                        Swal.fire('Berhasil!', 'Kelas berhasil ditambahkan.', 'success');
                        document.getElementById('classForm').reset();
                    })
                    .catch(error => {
                        console.error('Error adding class:', error);
                        Swal.fire('Gagal', 'Terjadi kesalahan saat menambahkan kelas.', 'error');
                    });
            }

            function showEditClassModal(id) {
                database.ref('classes/' + id).once('value')
                    .then(snapshot => {
                        const classItem = snapshot.val();
                        if (classItem) {
                            document.getElementById('editClassId').value = classItem.id;
                            document.getElementById('editClassNameInput').value = classItem.name;
                            
                            document.getElementById('editClassModal').classList.remove('hidden');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching class:', error);
                    });
            }

            function updateClass() {
                const id = document.getElementById('editClassId').value;
                const updatedClass = {
                    id: id,
                    name: document.getElementById('editClassNameInput').value.trim()
                };

                if (!updatedClass.name) {
                    Swal.fire('Gagal!', 'Nama kelas harus diisi.', 'warning');
                    return;
                }

                database.ref('classes/' + id).update(updatedClass)
                    .then(() => {
                        Swal.fire('Berhasil!', 'Data kelas berhasil diperbarui.', 'success');
                        document.getElementById('editClassModal').classList.add('hidden');
                    })
                    .catch(error => {
                        console.error('Error updating class:', error);
                        Swal.fire('Gagal', 'Terjadi kesalahan saat memperbarui kelas.', 'error');
                    });
            }

            function deleteClass(id) {
                database.ref('classes/' + id).remove()
                    .then(() => {
                        Swal.fire('Berhasil!', 'Kelas berhasil dihapus.', 'success');
                    })
                    .catch(error => {
                        console.error('Error deleting class:', error);
                        Swal.fire('Gagal', 'Terjadi kesalahan saat menghapus kelas.', 'error');
                    });
            }

            function resetAllData() {
                showConfirmation('Hapus Semua Jadwal?', 'Tindakan ini tidak dapat dibatalkan dan akan menghapus semua data jadwal.', () => {
                    database.ref('schedules').remove()
                        .then(() => {
                            schedules = [];
                            renderAllViews();
                            renderScheduleTable();
                            Swal.fire('Berhasil!', 'Semua jadwal telah direset.', 'success');
                        })
                        .catch(error => {
                            console.error('Error resetting schedules:', error);
                            Swal.fire('Gagal', 'Terjadi kesalahan saat mereset jadwal.', 'error');
                        });
                });
            }

            // ====================
            // IMPORT/EXPORT FUNCTIONS
            // ====================
            function openExportScheduleModal() {
                document.getElementById('exportScheduleModal').classList.remove('hidden');
            }

            function closeExportScheduleModal() {
                document.getElementById('exportScheduleModal')?.classList.add('hidden');
            }

            function exportScheduleToCSV() {
                const type = document.querySelector('input[name="exportType"]:checked')?.value;
                let filtered = schedules;

                if (type === 'day') {
                    const date = document.getElementById('exportDate').value;
                    if (!date) return Swal.fire('Gagal', 'Silakan pilih tanggal terlebih dahulu.', 'warning');
                    filtered = schedules.filter(s => s.date === date);
                } else if (type === 'week') {
                    const start = document.getElementById('exportWeekStart').value;
                    const end = document.getElementById('exportWeekEnd').value;
                    if (!start || !end) return Swal.fire('Gagal', 'Silakan pilih tanggal mulai dan akhir.', 'warning');
                    if (start > end) return Swal.fire('Gagal', 'Tanggal mulai tidak boleh lebih besar dari tanggal akhir.', 'warning');
                    filtered = schedules.filter(s => s.date >= start && s.date <= end);
                } else if (type === 'month') {
                    const month = document.getElementById('exportMonth').value;
                    const year = document.getElementById('exportYear').value;
                    if (!month || !year) return Swal.fire('Gagal', 'Silakan pilih bulan dan tahun.', 'warning');
                    const monthStr = `${year}-${month.toString().padStart(2, '0')}`;
                    filtered = schedules.filter(s => s.date.startsWith(monthStr));
                } else if (type === 'category') {
                    const category = document.getElementById('exportCategory').value;
                    const value = document.getElementById('exportCategoryValue').value;
                    if (!category || !value) return Swal.fire('Gagal', 'Silakan pilih dan isi kategori yang akan diekspor.', 'warning');
                    filtered = schedules.filter(s => s[category] === value);
                }

                if (filtered.length === 0) {
                    Swal.fire('Info', 'Tidak ada data jadwal yang cocok untuk diekspor.', 'info');
                    return;
                }
                
                Swal.fire({
                    title: 'Mempersiapkan Ekspor...',
                    text: `Mengekspor ${filtered.length} data jadwal.`,
                    icon: 'info',
                    showConfirmButton: false,
                    timer: 1500
                });

                const formatted = filtered.map(s => ({
                    Tanggal: s.date,
                    'Waktu Mulai': s.startTime,
                    'Waktu Selesai': s.endTime,
                    'Mata Pelajaran': s.subject,
                    Pengajar: s.teacher,
                    Lokasi: s.location,
                    Kelas: s.class || '-'
                }));

                const ws = XLSX.utils.json_to_sheet(formatted);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Jadwal");

                const dateStr = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `jadwal-${type}-${dateStr}.xlsx`);

                closeExportScheduleModal();
            }

            function exportWeeklySummaryToExcel() {
                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                const dateRangeText = currentWeekElement.textContent;
                
                Swal.fire({
                    title: 'Konfirmasi Ekspor',
                    text: `Anda akan mengekspor rekap mingguan untuk periode ${dateRangeText}. Lanjutkan?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Ya, Ekspor!',
                    cancelButtonText: 'Batal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const weekSchedules = schedules.filter(schedule => {
                            const scheduleDate = new Date(schedule.date);
                            return scheduleDate >= currentWeekStart && scheduleDate <= weekEnd;
                        });

                        if (weekSchedules.length === 0) {
                            Swal.fire('Info', 'Tidak ada data rekap pada minggu ini untuk diekspor.', 'info');
                            return;
                        }

                        const teacherStats = {};
                        const subjectStats = {};

                        weekSchedules.forEach(schedule => {
                            const startParts = schedule.startTime.split(':');
                            const endParts = schedule.endTime.split(':');
                            const duration = (parseInt(endParts[0]) - parseInt(startParts[0])) + (parseInt(endParts[1]) - parseInt(startParts[1])) / 60;
                            
                            if (!teacherStats[schedule.teacher]) {
                                teacherStats[schedule.teacher] = { hours: 0, sessions: 0, subjects: new Set() };
                            }
                            teacherStats[schedule.teacher].hours += duration;
                            teacherStats[schedule.teacher].sessions++;
                            teacherStats[schedule.teacher].subjects.add(schedule.subject);

                            if (!subjectStats[schedule.subject]) {
                                subjectStats[schedule.subject] = { hours: 0, sessions: 0, teachers: new Set() };
                            }
                            subjectStats[schedule.subject].hours += duration;
                            subjectStats[schedule.subject].sessions++;
                            subjectStats[schedule.subject].teachers.add(schedule.teacher);
                        });

                        const formattedTeacherData = Object.entries(teacherStats).map(([name, stats]) => ({
                            'Nama Pengajar': name,
                            'Total Jam': stats.hours.toFixed(1),
                            'Jumlah Sesi': stats.sessions,
                            'Mata Pelajaran': [...stats.subjects].join(', ')
                        }));

                        const formattedSubjectData = Object.entries(subjectStats).map(([name, stats]) => ({
                            'Nama Mata Pelajaran': name,
                            'Total Jam': stats.hours.toFixed(1),
                            'Jumlah Sesi': stats.sessions,
                            'Daftar Pengajar': [...stats.teachers].join(', ')
                        }));

                        const wb = XLSX.utils.book_new();
                        const ws_teachers = XLSX.utils.json_to_sheet(formattedTeacherData);
                        const ws_subjects = XLSX.utils.json_to_sheet(formattedSubjectData);

                        XLSX.utils.book_append_sheet(wb, ws_teachers, "Rekap Pengajar");
                        XLSX.utils.book_append_sheet(wb, ws_subjects, "Rekap Mata Pelajaran");

                        const dateStr = currentWeekStart.toLocaleDateString('id-ID', {day:'2-digit', month:'short', year:'numeric'});
                        XLSX.writeFile(wb, `rekap-mingguan-${dateStr}.xlsx`);
                        
                        Swal.fire('Berhasil!', 'Data rekap mingguan telah diekspor.', 'success');
                    }
                });
            }
            
            function downloadImportTemplate() {
                const sampleData = [
                    {
                        "Tanggal": "2025-10-27",
                        "Waktu Mulai": "08:00",
                        "Waktu Selesai": "09:30",
                        "Mata Pelajaran": "Matematika",
                        "Pengajar": "Budi Santoso",
                        "Lokasi": "Ruang 101",
                        "Kelas": "10-A"
                    },
                    {
                        "Tanggal": "2025-10-28",
                        "Waktu Mulai": "10:00",
                        "Waktu Selesai": "11:30",
                        "Mata Pelajaran": "Bahasa Indonesia",
                        "Pengajar": "Ani Lestari",
                        "Lokasi": "Ruang 102",
                        "Kelas": "11-B"
                    }
                ];
                const ws = XLSX.utils.json_to_sheet(sampleData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Jadwal");
                XLSX.writeFile(wb, "template-impor-jadwal.xlsx");
            }


            function isScheduleConflict(newSchedule) {
                if (!Array.isArray(schedules)) return false;
                return schedules.some(existing => {
                    return (
                        existing.date === newSchedule.date &&
                        existing.location === newSchedule.location &&
                        !(
                            newSchedule.endTime <= existing.startTime ||
                            newSchedule.startTime >= existing.endTime
                        )
                    );
                });
            }

            function isValidReference(item) {
                const teacherValid = teachers.some(t => t.name === item.teacher);
                const subjectValid = subjects.some(s => s.name === item.subject);
                const locationValid = locations.some(l => l.name === item.location);
                const classValid = !item.class || classes.some(c => c.name === item.class);
                return { teacherValid, subjectValid, locationValid, classValid };
            }

            // ====================
            // BUTTON STATE UPDATERS
            // ====================
            function updateDeleteSelectedScheduleButtonState() {
                const selected = document.querySelectorAll('.schedule-checkbox:checked').length;
                const btn = document.getElementById('deleteSelectedSchedules');
                if (selected > 0) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }

            function updateDeleteSelectedTeacherButtonState() {
                const selected = document.querySelectorAll('.teacher-checkbox:checked').length;
                const btn = document.getElementById('deleteSelectedTeachers');
                if (selected > 0) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }

            function updateDeleteSelectedSubjectButtonState() {
                const selected = document.querySelectorAll('.subject-checkbox:checked').length;
                const btn = document.getElementById('deleteSelectedSubjects');
                if (selected > 0) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }

            function updateDeleteSelectedLocationButtonState() {
                const selected = document.querySelectorAll('.location-checkbox:checked').length;
                const btn = document.getElementById('deleteSelectedLocations');
                if (selected > 0) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }

            function updateDeleteSelectedClassButtonState() {
                const selected = document.querySelectorAll('.class-checkbox:checked').length;
                const btn = document.getElementById('deleteSelectedClasses');
                if (selected > 0) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }

            // ====================
            // EVENT LISTENERS
            // ====================
            // View navigation
            btnDailyView.addEventListener('click', () => {
                inputManagement.classList.remove('active');
                dailyView.classList.remove('hidden');
                weeklyView.classList.add('hidden');
                monthlyView.classList.add('hidden');
            });

            btnWeeklyView.addEventListener('click', () => {
                inputManagement.classList.remove('active');
                dailyView.classList.add('hidden');
                weeklyView.classList.remove('hidden');
                monthlyView.classList.add('hidden');
            });

            btnMonthlyView.addEventListener('click', () => {
                inputManagement.classList.remove('active');
                dailyView.classList.add('hidden');
                weeklyView.classList.add('hidden');
                monthlyView.classList.remove('hidden');
            });

            btnPrint.addEventListener('click', () => {
                inputManagement.classList.remove('active');
                window.print();
            });

            btnReset.addEventListener('click', resetAllData);

            // Date navigation
            prevDay.addEventListener('click', () => {
                const date = new Date(currentDateInput.value);
                date.setDate(date.getDate() - 1);
                currentDateInput.valueAsDate = date;
                renderDailyView();
            });

            nextDay.addEventListener('click', () => {
                const date = new Date(currentDateInput.value);
                date.setDate(date.getDate() + 1);
                currentDateInput.valueAsDate = date;
                renderDailyView();
            });

            currentDateInput.addEventListener('change', renderDailyView);
            scheduleDateInput.addEventListener('change', () => {
                currentDateInput.value = scheduleDateInput.value;
                renderDailyView();
            });

            prevWeek.addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                updateCurrentWeekDisplay();
                renderWeeklyView();
            });

            nextWeek.addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                updateCurrentWeekDisplay();
                renderWeeklyView();
            });

            prevMonth.addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                updateCurrentMonthDisplay();
                renderMonthlyView();
            });

            nextMonth.addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                updateCurrentMonthDisplay();
                renderMonthlyView();
            });

            // Form submissions
            scheduleForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addNewSchedule();
            });

            editScheduleForm.addEventListener('submit', function(e) {
                e.preventDefault();
                updateSchedule();
            });

            cancelEdit.addEventListener('click', function() {
                editModal.classList.add('hidden');
            });

            document.getElementById('teacherForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewTeacher();
            });

            document.getElementById('editTeacherForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateTeacher();
            });

            document.getElementById('cancelEditTeacher').addEventListener('click', function() {
                document.getElementById('editTeacherModal').classList.add('hidden');
            });

            document.getElementById('subjectForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewSubject();
            });

            document.getElementById('editSubjectForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateSubject();
            });

            document.getElementById('cancelEditSubject').addEventListener('click', function() {
                document.getElementById('editSubjectModal').classList.add('hidden');
            });

            document.getElementById('locationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewLocation();
            });

            document.getElementById('editLocationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateLocation();
            });

            document.getElementById('cancelEditLocation').addEventListener('click', function() {
                document.getElementById('editLocationModal').classList.add('hidden');
            });

            document.getElementById('classForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewClass();
            });

            document.getElementById('editClassForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateClass();
            });

            document.getElementById('cancelEditClass').addEventListener('click', function() {
                document.getElementById('editClassModal').classList.add('hidden');
            });

            // Input options
            inputOptions.forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    const type = this.dataset.type;
                    currentInputType = type;

                    toggleInputSection(type);

                    // Hide other views
                    dailyView.classList.add('hidden');
                    weeklyView.classList.add('hidden');
                    monthlyView.classList.add('hidden');
                });
            });


            // Search and filter handlers
            document.getElementById('scheduleSearch').addEventListener('input', (e) => {
                paginationConfig.schedule.searchTerm = e.target.value.toLowerCase();
                paginationConfig.schedule.currentPage = 1;
                renderScheduleTable();
            });
            
            btnResetFilter.addEventListener('click', () => {
                document.getElementById('filterDate').value = '';
                document.getElementById('filterTime').value = '';
                document.getElementById('filterSubject').value = '';
                document.getElementById('filterTeacher').value = '';
                document.getElementById('filterLocation').value = '';
                document.getElementById('filterClass').value = '';
                document.getElementById('scheduleSearch').value = '';

                paginationConfig.schedule.searchTerm = '';
                paginationConfig.schedule.currentPage = 1;
                paginationConfig.schedule.sortKey = null;

                renderScheduleTable();
            });


            document.getElementById('scheduleEntriesPerPage').addEventListener('change', (e) => {
                paginationConfig.schedule.entriesPerPage = parseInt(e.target.value);
                paginationConfig.schedule.currentPage = 1;
                renderScheduleTable();
            });

            document.querySelectorAll('#scheduleTable thead th[data-sort]').forEach(th => {
                th.style.cursor = 'pointer';
                th.addEventListener('click', () => {
                    const key = th.dataset.sort;
                    if (paginationConfig.schedule.sortKey === key) {
                        paginationConfig.schedule.sortAsc = !paginationConfig.schedule.sortAsc;
                    } else {
                        paginationConfig.schedule.sortKey = key;
                        paginationConfig.schedule.sortAsc = true;
                    }
                    renderScheduleTable();
                });
            });

            document.querySelectorAll('#filterDate, #filterTime, #filterSubject, #filterTeacher, #filterLocation, #filterClass')
                .forEach(input => {
                    input.addEventListener('input', () => {
                        paginationConfig.schedule.currentPage = 1;
                        renderScheduleTable();
                    });
                });

            // Teacher table handlers
            document.getElementById('teacherSearch').addEventListener('input', (e) => {
                paginationConfig.teacher.searchTerm = e.target.value.toLowerCase();
                paginationConfig.teacher.currentPage = 1;
                renderTeacherTable();
            });

            document.getElementById('teacherEntriesPerPage').addEventListener('change', (e) => {
                paginationConfig.teacher.entriesPerPage = parseInt(e.target.value);
                paginationConfig.teacher.currentPage = 1;
                renderTeacherTable();
            });

            document.querySelectorAll('#teacherTable thead th[data-sort]').forEach(th => {
                th.style.cursor = 'pointer';
                th.addEventListener('click', () => {
                    const key = th.dataset.sort;
                    if (paginationConfig.teacher.sortKey === key) {
                        paginationConfig.teacher.sortAsc = !paginationConfig.teacher.sortAsc;
                    } else {
                        paginationConfig.teacher.sortKey = key;
                        paginationConfig.teacher.sortAsc = true;
                    }
                    renderTeacherTable();
                });
            });

            // Subject table handlers
            document.getElementById('subjectSearch').addEventListener('input', (e) => {
                paginationConfig.subject.searchTerm = e.target.value.toLowerCase();
                paginationConfig.subject.currentPage = 1;
                renderSubjectTable();
            });

            document.getElementById('subjectEntriesPerPage').addEventListener('change', (e) => {
                paginationConfig.subject.entriesPerPage = parseInt(e.target.value);
                paginationConfig.subject.currentPage = 1;
                renderSubjectTable();
            });

            document.querySelectorAll('#subjectTable thead th[data-sort]').forEach(th => {
                th.style.cursor = 'pointer';
                th.addEventListener('click', () => {
                    const key = th.dataset.sort;
                    if (paginationConfig.subject.sortKey === key) {
                        paginationConfig.subject.sortAsc = !paginationConfig.subject.sortAsc;
                    } else {
                        paginationConfig.subject.sortKey = key;
                        paginationConfig.subject.sortAsc = true;
                    }
                    renderSubjectTable();
                });
            });

            // Location table handlers
            document.getElementById('locationSearch').addEventListener('input', (e) => {
                paginationConfig.location.searchTerm = e.target.value.toLowerCase();
                paginationConfig.location.currentPage = 1;
                renderLocationTable();
            });

            document.getElementById('locationEntriesPerPage').addEventListener('change', (e) => {
                paginationConfig.location.entriesPerPage = parseInt(e.target.value);
                paginationConfig.location.currentPage = 1;
                renderLocationTable();
            });

            document.querySelectorAll('#locationTable thead th[data-sort]').forEach(th => {
                th.style.cursor = 'pointer';
                th.addEventListener('click', () => {
                    const key = th.dataset.sort;
                    if (paginationConfig.location.sortKey === key) {
                        paginationConfig.location.sortAsc = !paginationConfig.location.sortAsc;
                    } else {
                        paginationConfig.location.sortKey = key;
                        paginationConfig.location.sortAsc = true;
                    }
                    renderLocationTable();
                });
            });

            // Class table handlers
            document.getElementById('classSearch').addEventListener('input', (e) => {
                paginationConfig.class.searchTerm = e.target.value.toLowerCase();
                paginationConfig.class.currentPage = 1;
                renderClassTable();
            });

            document.getElementById('classEntriesPerPage').addEventListener('change', (e) => {
                paginationConfig.class.entriesPerPage = parseInt(e.target.value);
                paginationConfig.class.currentPage = 1;
                renderClassTable();
            });

            document.querySelectorAll('#classTable thead th[data-sort]').forEach(th => {
                th.style.cursor = 'pointer';
                th.addEventListener('click', () => {
                    const key = th.dataset.sort;
                    if (paginationConfig.class.sortKey === key) {
                        paginationConfig.class.sortAsc = !paginationConfig.class.sortAsc;
                    } else {
                        paginationConfig.class.sortKey = key;
                        paginationConfig.class.sortAsc = true;
                    }
                    renderClassTable();
                });
            });

            // Bulk delete handlers
            document.getElementById('deleteSelectedSchedules').addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.schedule-checkbox:checked'))
                    .map(cb => cb.dataset.id);

                if (selectedIds.length === 0) return;

                showConfirmation(`Hapus ${selectedIds.length} Jadwal?`, 'Jadwal yang dipilih akan dihapus permanen.', () => {
                    const promises = selectedIds.map(id => database.ref('schedules/' + id).remove());
                    Promise.all(promises)
                        .then(() => {
                            Swal.fire('Berhasil!', `${selectedIds.length} jadwal telah dihapus.`, 'success');
                        })
                        .catch((error) => {
                            console.error('Gagal hapus jadwal:', error);
                            Swal.fire('Gagal', 'Terjadi kesalahan saat menghapus.', 'error');
                        });
                });
            });

            document.getElementById('deleteSelectedTeachers').addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.teacher-checkbox:checked'))
                    .map(cb => cb.dataset.id);

                if (selectedIds.length === 0) return;

                showConfirmation(`Hapus ${selectedIds.length} Pengajar?`, 'Data yang dipilih akan dihapus permanen.', () => {
                    const promises = selectedIds.map(id => database.ref('teachers/' + id).remove());
                    Promise.all(promises)
                        .then(() => {
                            Swal.fire('Berhasil!', `${selectedIds.length} pengajar telah dihapus.`, 'success');
                        })
                        .catch((error) => {
                            console.error('Gagal hapus beberapa pengajar:', error);
                            Swal.fire('Gagal', 'Terjadi kesalahan saat menghapus data.', 'error');
                        });
                });
            });

            document.getElementById('deleteSelectedSubjects').addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.subject-checkbox:checked'))
                    .map(cb => cb.dataset.id);

                if (selectedIds.length === 0) return;

                showConfirmation(`Hapus ${selectedIds.length} Mata Pelajaran?`, 'Data yang dipilih akan dihapus permanen.', () => {
                    const promises = selectedIds.map(id => database.ref('subjects/' + id).remove());
                    Promise.all(promises)
                        .then(() => {
                            Swal.fire('Berhasil!', `${selectedIds.length} mata pelajaran telah dihapus.`, 'success');
                        })
                        .catch((error) => {
                            console.error('Gagal hapus:', error);
                            Swal.fire('Gagal', 'Terjadi kesalahan saat menghapus.', 'error');
                        });
                });
            });

            document.getElementById('deleteSelectedLocations').addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.location-checkbox:checked'))
                    .map(cb => cb.dataset.id);

                if (selectedIds.length === 0) return;

                showConfirmation(`Hapus ${selectedIds.length} Lokasi?`, 'Data yang dipilih akan dihapus permanen.', () => {
                    const promises = selectedIds.map(id => database.ref('locations/' + id).remove());
                    Promise.all(promises)
                        .then(() => {
                            Swal.fire('Berhasil!', `${selectedIds.length} lokasi telah dihapus.`, 'success');
                        })
                        .catch((error) => {
                            console.error('Gagal hapus lokasi:', error);
                            Swal.fire('Gagal', 'Terjadi kesalahan saat menghapus.', 'error');
                        });
                });
            });

            document.getElementById('deleteSelectedClasses').addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.class-checkbox:checked'))
                    .map(cb => cb.dataset.id);

                if (selectedIds.length === 0) return;

                showConfirmation(`Hapus ${selectedIds.length} Kelas?`, 'Data yang dipilih akan dihapus permanen.', () => {
                    const promises = selectedIds.map(id => database.ref('classes/' + id).remove());
                    Promise.all(promises)
                        .then(() => {
                            Swal.fire('Berhasil!', `${selectedIds.length} kelas telah dihapus.`, 'success');
                        })
                        .catch((error) => {
                            console.error('Gagal hapus kelas:', error);
                            Swal.fire('Gagal', 'Terjadi kesalahan saat menghapus.', 'error');
                        });
                });
            });

            // Export handlers
            btnExport.addEventListener('click', openExportScheduleModal);
            btnExportWeekly.addEventListener('click', exportWeeklySummaryToExcel);

            document.getElementById('btnExportSchedule').addEventListener('click', exportScheduleToCSV);
            document.getElementById('closeExportScheduleBtn').addEventListener('click', closeExportScheduleModal);
            document.getElementById('cancelExportScheduleBtn').addEventListener('click', closeExportScheduleModal);

            document.querySelectorAll('input[name="exportType"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    const value = radio.value;
                    const categorySelect = document.getElementById('exportCategory');
                    const valueSelect = document.getElementById('exportCategoryValue');

                    document.getElementById('exportDate')?.classList.add('hidden');
                    document.getElementById('exportWeekRange')?.classList.add('hidden');
                    document.getElementById('exportMonthYear')?.classList.add('hidden');
                    categorySelect?.classList.add('hidden');
                    valueSelect?.classList.add('hidden');

                    if (value === 'day') {
                        document.getElementById('exportDate')?.classList.remove('hidden');
                    } else if (value === 'week') {
                        document.getElementById('exportWeekRange')?.classList.remove('hidden');
                    } else if (value === 'month') {
                        document.getElementById('exportMonthYear')?.classList.remove('hidden');
                    } else if (value === 'category') {
                        categorySelect?.classList.remove('hidden');
                        if (categorySelect.value) {
                            valueSelect?.classList.remove('hidden');
                        }
                    }
                });
            });
            
            document.getElementById('exportCategory').addEventListener('change', (e) => {
                const category = e.target.value;
                const valueDropdown = document.getElementById('exportCategoryValue');
                valueDropdown.innerHTML = ''; // Kosongkan opsi sebelumnya

                if (!category) {
                    valueDropdown.classList.add('hidden');
                    return;
                }

                let data = [];
                switch (category) {
                    case 'class': data = classes; break;
                    case 'subject': data = subjects; break;
                    case 'teacher': data = teachers; break;
                    case 'location': data = locations; break;
                }

                valueDropdown.innerHTML = '<option value="">Pilih Item...</option>';
                data.sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.name;
                    option.textContent = item.name;
                    valueDropdown.appendChild(option);
                });

                valueDropdown.classList.remove('hidden');
            });


            // Import handlers
            document.getElementById('btnOpenImportModal').addEventListener('click', () => {
                const modal = document.getElementById('importScheduleModal');
                const preview = document.getElementById('importPreview');
                modal.classList.remove('hidden');
                preview.innerHTML = '';
                preview.classList.add('hidden');
                document.getElementById('fileInput').value = '';
                document.getElementById('btnConfirmImport').disabled = true;
            });

            document.getElementById('btnCancelImport').addEventListener('click', () => {
                document.getElementById('importScheduleModal').classList.add('hidden');
            });
            
            document.getElementById('downloadTemplateBtn').addEventListener('click', downloadImportTemplate);

            document.getElementById('fileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);

                    importedSchedules = json.map(item => {
                        const schedule = {
                            date: formatDate(item.Tanggal),
                            startTime: convertTimeFormat(item['Waktu Mulai']),
                            endTime: convertTimeFormat(item['Waktu Selesai']),
                            subject: item['Mata Pelajaran'],
                            teacher: item.Pengajar,
                            location: item.Lokasi,
                            class: item.Kelas || ''
                        };

                        const conflict = isScheduleConflict(schedule);
                        const ref = isValidReference(schedule);

                        schedule.__valid = (
                            !conflict &&
                            ref.teacherValid &&
                            ref.subjectValid &&
                            ref.locationValid &&
                            ref.classValid
                        );

                        schedule.__conflict = conflict;
                        schedule.__ref = ref;

                        return schedule;
                    });

                    const tableRows = importedSchedules.map(row => {
                        const { teacherValid, subjectValid, locationValid, classValid } = row.__ref;
                        return `
                        <tr class="${row.__valid ? '' : 'bg-red-100'}">
                            <td class="border px-2">${row.date}</td>
                            <td class="border px-2">${row.startTime}</td>
                            <td class="border px-2">${row.endTime}</td>
                            <td class="border px-2">${row.subject}${!subjectValid ? ' ❌' : ''}</td>
                            <td class="border px-2">${row.teacher}${!teacherValid ? ' ❌' : ''}</td>
                            <td class="border px-2">${row.location}${!locationValid ? ' ❌' : ''}</td>
                            <td class="border px-2">${row.class || '-'}${!classValid ? ' ❌' : ''}</td>
                        </tr>
                        `;
                    });

                    const preview = document.getElementById('importPreview');
                    preview.innerHTML = `
                        <table class="w-full border text-xs">
                        <thead><tr>
                            <th class="border px-2">Tanggal</th>
                            <th class="border px-2">Mulai</th>
                            <th class="border px-2">Selesai</th>
                            <th class="border px-2">Mapel</th>
                            <th class="border px-2">Pengajar</th>
                            <th class="border px-2">Lokasi</th>
                            <th class="border px-2">Kelas</th>
                        </tr></thead>
                        <tbody>
                            ${tableRows.join('')}
                        </tbody>
                        </table>
                    `;

                    preview.classList.remove('hidden');

                    const allValid = importedSchedules.every(item => item.__valid);
                    document.getElementById('btnConfirmImport').disabled = !allValid;
                };

                reader.readAsArrayBuffer(file);
            });

            document.getElementById('btnConfirmImport').addEventListener('click', async () => {
                try {
                    const btn = document.getElementById('btnConfirmImport');
                    btn.disabled = true;
                    btn.textContent = 'Menyimpan...';

                    const validSchedules = importedSchedules.filter(item => item.__valid);

                    const promises = validSchedules.map(item => {
                        const newId = Date.now().toString() + '_' + Math.floor(Math.random() * 1000);
                        return database.ref('schedules/' + newId).set({
                            id: newId,
                            date: item.date,
                            startTime: item.startTime,
                            endTime: item.endTime,
                            subject: item.subject,
                            teacher: item.teacher,
                            location: item.location,
                            class: item.class || ''
                        });
                    });

                    await Promise.all(promises);

                    Swal.fire('Berhasil', `${validSchedules.length} jadwal berhasil diimpor.`, 'success');

                    document.getElementById('importScheduleModal').classList.add('hidden');
                    btn.textContent = 'Impor ke Firebase';

                } catch (error) {
                    console.error('Gagal menyimpan jadwal:', error);
                    Swal.fire('Gagal', 'Terjadi kesalahan saat menyimpan ke Firebase.', 'error');
                    document.getElementById('btnConfirmImport').disabled = false;
                    document.getElementById('btnConfirmImport').textContent = 'Impor ke Firebase';
                }
            });

            function populateMonthDropdown() {
                const monthSelect = document.getElementById('exportMonth');
                if (!monthSelect) return;
                
                monthSelect.innerHTML = '<option value="">Pilih Bulan</option>';
                for (let i = 0; i < 12; i++) {
                    const monthName = new Date(2000, i).toLocaleString('id-ID', { month: 'long' });
                    const option = document.createElement('option');
                    option.value = i + 1;
                    option.textContent = monthName;
                    monthSelect.appendChild(option);
                }
            }

            // ====================
            // INITIALIZATION
            // ====================
            function initialize() {
                populateMonthDropdown();
                currentDateInput.valueAsDate = new Date();
                scheduleDateInput.valueAsDate = new Date();
                
                // ✅ REVISI: Memanggil fungsi untuk menampilkan minggu saat ini ketika halaman dimuat
                updateCurrentWeekDisplay();
                
                loadSchedules();
                loadTeachers();
                loadSubjects();
                loadLocations();
                loadClasses();
                setupRealtimeListener();
                
                inputManagement.classList.remove('active');
                toggleInputSection('schedule');
                dailyView.classList.add('hidden');
                weeklyView.classList.add('hidden');
                monthlyView.classList.add('hidden');

                btnDailyView.click();
            }

            // Start the application
            initialize();
        });
    </script>
</body>
</html>